<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=5">

  
  <title>Deploying in Kubernetes. Checklist.</title>


  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="Oleg Atamanenko">


  <link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/go-mono" type="text/css"/>
  <link rel="stylesheet" media="screen" href="https://fonts.googleapis.com/css?family=Arvo" type="text/css"/>


  
  
  <link rel="stylesheet" href="https://uthark.github.io/css/uthark.css">

  
  

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  <link href="https://uthark.github.io/favicon.png" rel="icon">

  
  
  


  


  
  <link href="https://feeds.feedburner.com/atamanenko" rel="alternate" type="application/rss+xml" title="Sharing knowledge" />
  

  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@LinkageError">
  <meta name="twitter:creator" content="@LinkageError">

  <meta name="twitter:title" content="Deploying in Kubernetes. Checklist.">

  

  <meta property="og:title" content="Deploying in Kubernetes. Checklist." />
  <meta property="og:url" content="https://uthark.github.io/post/2020-09-04-deploy-project-kubernetes-checklist/" />
  <meta property="og:description" content="Deploying to kubernetes is easy: create manifest with your Deployment and then kubectl apply it.
The most basic deployment manifest looks like this:
apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: test-app name: test-app namespace: default spec: selector: matchLabels: app.kubernetes.io/name: test-app template: metadata: labels: app.kubernetes.io/name: test-app spec: containers: - name: controller image: nginx It works as is, but you may improve reliability of this deployment by configuring additional fields for the manifest." />

  




</head>
<body>

<header>
  
  <h1><a href="https://uthark.github.io/">Sharing knowledge</a></h1>
    <h2>by Oleg Atamanenko</h2>
</header>


<nav>

<ul class="main-navigation">
  
  
    
      <li><a href="https://uthark.github.io/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://uthark.github.io/usefularticles/" title="Useful Articles" >Useful Articles</a></li>
    
  
    
      <li><a href="https://uthark.github.io/categories/" title="Categories" >Categories</a></li>
    
  
    
      <li><a href="https://uthark.github.io/readinglist/" title="Reading Lists" >Reading Lists</a></li>
    
  
    
      <li><a href="https://uthark.github.io/about/" title="About" >About</a></li>
    
  
</ul>


<ul class="subscription">
  
    
        
        
        <li><a href="https://feeds.feedburner.com/atamanenko" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a></li>
        

    
  

</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" placeholder="Search"/>
    <input type="hidden" name="q" value="site:https://uthark.github.io/" />
  </fieldset>
</form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry">

        
        
<div class="sharing">
    <a href="https://getpocket.com/save?url=https%3a%2f%2futhark.github.io%2fpost%2f2020-09-04-deploy-project-kubernetes-checklist%2f" target="_blank" ><i class="fa fa-get-pocket" title="Save to Pocket" aria-hidden="true"></i></a>
    <a href="https://twitter.com/intent/tweet?text=Deploying%20in%20Kubernetes.%20Checklist.&url=https%3a%2f%2futhark.github.io%2fpost%2f2020-09-04-deploy-project-kubernetes-checklist%2f" target="_blank" title="Post to Twitter" aria-hidden="true"><i class="fa fa-twitter"></i></a>
</div>
<header>
    <h1 class="entry-title">
         Deploying in Kubernetes. Checklist. 
    </h1>

</header>


        <div class="entry-content">
          
          
          
          
          <p>Deploying to kubernetes is easy: create manifest with your <code>Deployment</code> and then <code>kubectl apply</code> it.</p>
<p>The most basic deployment manifest looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: test-app
  name: test-app
  namespace: default
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: test-app
  template:
    metadata:
      labels:
        app.kubernetes.io/name: test-app
    spec:
      containers:
      - name: controller
        image: nginx
</code></pre></div><p>It works as is, but you may improve reliability of this deployment by configuring additional fields for the manifest.</p>
<h2 id="metadata">Metadata</h2>
<p>Use <code>metadata</code> field efficiently. You can add labels who owns the deployment, if they are part of the bigger project, and so on.
This will allow to discover all deployments that are owned by a specific department:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl get deploy -n production -l department=marketing
</code></pre></div><h2 id="cpumemory-requestsresources">CPU/Memory Requests/Resources</h2>
<p>Correct configuration is important. Requests are used for scheduling (kubelet reports node configuration to scheduler and scheduler uses this information when decides where the pod will be assigned). Limits are used for enforcing usage in runtime.</p>
<h3 id="things-to-remember">Things to remember:</h3>
<ol>
<li>If you go over memory limit, app will be OOMKilled.</li>
<li>If you go over CPU limit, app will be throttled. In fact this is more complicated and your app may be throttled before reaching limit, but this is a topic for another post.</li>
<li>The configuration set affects <a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/">Quality of Service</a> for pod.</li>
<li>QoS affects what happens with your pod when kubelet on the node is <a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#best-practices">out of resources</a></li>
</ol>
<h2 id="do-not-use-latest-tag-in-images">Do not use <code>latest</code> tag in images</h2>
<p>I <a href="https://uthark.github.io/post/2020-09-03-docker-best-practices/">spoke about it previously</a>. Use exact version, i.e. <code>nginx:1.19.2</code>. This is better than <code>latest</code>, but even better to use sha256 of the image:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">image: nginx@sha256:9d660d69e53c286fbdd472122b4b583a46e8a27f10515e415d2578f8478b9aad
</code></pre></div><h2 id="update-strategy">Update Strategy</h2>
<p>Default strategy is <code>RollingUpdate</code>. If you run multiple replicas of the application, consider tuning <code>maxUnavailable</code>/<code>maxSurge</code> based on your requirements.
If your app have multiple replicas and each replica requires a lot of CPU/Memory, having <code>maxSurge</code> might require autoscaler to provision extra nodes.</p>
<h2 id="service-accounts">Service Accounts</h2>
<p>By default, each deployment will use <code>default</code> service account. If app requires access to kubernetes API, consider creating separate service account for the app. This will allow improve your isolation and security:</p>
<ol>
<li>Use <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">PodSecurityPolicy</a> for fine-grained authorization of what’s allowed to pod to do on the node.</li>
<li>Use <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">RBAC ClusterRoleBinding/RoleBinding</a> to control permissions for the resources in Kubernetes.</li>
</ol>
<h2 id="securitycontext">SecurityContext</h2>
<p><code>securityContext</code> allows to control security context of the pod. Recommended to enforce <code>runAsNonRoot</code>. <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">See documentation</a></p>
<h2 id="pod-disruption-budget">Pod Disruption Budget</h2>
<p>If you have multiple replicas of the application, create <code>PodDisruptionBudget</code> for the <code>Deployment</code>. See <a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/">documentation</a> for more details.</p>
<h2 id="liveness--readiness-probes">Liveness &amp; Readiness Probes</h2>
<p>I cannot stress more importance of it. I’ve seen application being taken down when they should not and vice versa. Your biggest nightmare will be if you do a rollout when new pods are crashlooping and olds pods are not terminated when they should.</p>
<h2 id="lifecycle-hook---post-start--pre-stop">Lifecycle Hook - Post Start / Pre Stop</h2>
<p>Lifecycle hooks allows gracefully terminate application. I.e. you can finish current request, save state and then terminate. See <a href="https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/">documentation</a></p>
<h2 id="priority-classes">Priority Classes</h2>
<p>Not all apps are created equal. Some apps are more important. Consider defining priority classes and use appropriate priority class for the application. <a href="https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/" title="Pod Priority and Preemption">Read more in official documentation</a></p>
<h2 id="taints-and-tolerations">Taints and tolerations</h2>
<p>Sometimes there are specific requirements where application should or should not run.
Taints allows to taint nodes to prevent regular workload from scheduling on those node. To allow workload to be scheduled on the nodes - use Tolerations.
<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/">See documentation</a></p>
<h2 id="affinities-and-anti-affinities">Affinities and anti-affinities</h2>
<p>Affinities and anti-affinities provides you more control where to schedule the workload. For example, you might want to use pod anti-affinity to distribute replicas of the application across different nodes or availability zones. See <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/">documentation</a> for details.
Another great feature that you might need is <a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Topology Manager</a> for better allocation of the workload.</p>
<h2 id="references">References</h2>
<p>This is a must read documentation to learn / refresh your knowledge:</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Workload - Deployments</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/">Workload – Disruptions</a></li>
<li><a href="https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/">Container Lifecycle Hooks</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">Workload – Pod Lifecycle</a></li>
<li><a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Pod Security Policies</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">Configure a Security Context for a Pod or Container</a></li>
<li><a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/">Specifying a Disruption Budget for your Application</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">Configure Liveness, Readiness and Startup Probes</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Configure Service Accounts for Pods</a></li>
<li><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/">Scheduling and Eviction – Assigning Pods to Nodes</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/">Assign CPU Resources to Containers and Pods</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-memory-resource/">Assign Memory Resources to Containers and Pods</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#best-practices">Configure Out of Resource Handling</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Topology Manager</a></li>
<li><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Using RBAC Authorization</a></li>
<li><a href="https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/" title="Pod Priority and Preemption">Pod Priority and Preemption</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/">Configure Quality of Service for Pods</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#deployment-v1-apps">apps/v1 Deployment API Reference</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#podspec-v1-core">core/v1 PodSpec API Reference</a></li>
</ul>

        </div>
        

<footer>
  <div>
    <p>If you have any questions, feel free to ping me on Twitter.</p>
  </div>
  <p class="meta">
    
    
    
    
    Filed under: <a class="label"
      href="https://uthark.github.io/categories/kubernetes/">kubernetes</a><a class="label"
      href="https://uthark.github.io/categories/bestpractices/">bestpractices</a><a class="label"
      href="https://uthark.github.io/categories/development/">development</a>
    
  </p>

  <p class="meta">
    
    Last update: <time datetime="2020-09-04">Sep 4, 2020</time>

    
  <div>
    <span class="categories">
      Tags:
      
      <a class="category" href="https://uthark.github.io/tags/kubernetes/">kubernetes</a>
      <a class="category" href="https://uthark.github.io/tags/bestpractices/">bestpractices</a>
      
    </span>
  </div>
  
  </p>
  


  

  <p class="meta">
    
    <a class="basic-alignment left" href="https://uthark.github.io/post/2020-09-03-docker-best-practices/" title="Docker Best Practices">&lt;&lt;&nbsp;Docker Best Practices</a>
    

    
  </p>
  
  
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "uthark" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  
  
</footer>
      </article>
      
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>


<section class="even">
  <div class="toc-header">Table of Contents</div>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#metadata">Metadata</a></li>
    <li><a href="#cpumemory-requestsresources">CPU/Memory Requests/Resources</a>
      <ul>
        <li><a href="#things-to-remember">Things to remember:</a></li>
      </ul>
    </li>
    <li><a href="#do-not-use-latest-tag-in-images">Do not use <code>latest</code> tag in images</a></li>
    <li><a href="#update-strategy">Update Strategy</a></li>
    <li><a href="#service-accounts">Service Accounts</a></li>
    <li><a href="#securitycontext">SecurityContext</a></li>
    <li><a href="#pod-disruption-budget">Pod Disruption Budget</a></li>
    <li><a href="#liveness--readiness-probes">Liveness &amp; Readiness Probes</a></li>
    <li><a href="#lifecycle-hook---post-start--pre-stop">Lifecycle Hook - Post Start / Pre Stop</a></li>
    <li><a href="#priority-classes">Priority Classes</a></li>
    <li><a href="#taints-and-tolerations">Taints and tolerations</a></li>
    <li><a href="#affinities-and-anti-affinities">Affinities and anti-affinities</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
</section>





  

  

  
  
  

</aside>

  </div>
</div>

<footer>
    
    <div class="center">
        <ul class="sidebar-nav">
            <li class="sidebar-nav-item">
                <a target="_blank" href="https://github.com/uthark/" title="https://github.com/uthark/"><i
                    class="fa fa-github fa-3x"></i></a></li>
            <li class="sidebar-nav-item">    <a target="_blank" href="https://bitbucket.org/uthark/" title="https://bitbucket.org/uthark/"><i
                    class="fa fa-bitbucket fa-3x"></i></a>
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item"><a target="_blank" href="#ZgotmplZ" title="map[card:summary creator:@LinkageError site:@LinkageError]"><i
                    class="fa fa-twitter fa-3x"></i></a>
            <li class="sidebar-nav-item"><a target="_blank" href="https://keybase.io/uthark/" title="https://keybase.io/uthark/"><i
                    class="fa fa-key fa-3x"></i></a> 
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item"><a target="_blank" href="http://stackoverflow.com/users/216764/uthark" title="http://stackoverflow.com/users/216764/uthark"><i
                    class="fa fa-stack-overflow fa-3x"></i></a>
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
                
                
            </li>
        </ul>
    </div>
    <p>Copyright &copy; 2009&nbsp;—&nbsp;2020 Oleg Atamanenko - <a href="https://uthark.github.io/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a>, uses custom theme based on
            <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.</span>
    </p>

</footer>


<script>
    var _gaq = [['_setAccount', 'UA-8688665-1'], ['_trackPageview']];
    (function (d, t) {
        var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
        s.async = 'async'
        g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g, s)
    }(document, 'script'));
</script>


</body>
</html>

