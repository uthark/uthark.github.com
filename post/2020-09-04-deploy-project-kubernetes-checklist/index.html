<!doctype html><html>
<head>
<meta charset=utf-8>
<title>
Deploying in Kubernetes. Checklist. &ndash; Oleg Atamanenko
</title>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=theme-color content="#333" media="(prefers-color-scheme: dark)">
<meta name=theme-color content="#777" media="(prefers-color-scheme: light)">
<meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1">
<link rel=stylesheet media=screen href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300&family=Prata&display=swap" type=text/css>
<link rel=stylesheet href=https://uthark.github.io/css/theme.72254bdf9ec9fc2d8b013dd5c21997b2ab476af1a37ded5995aae71c4a63d57d.css>
<link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css>
<link href=https://uthark.github.io/favicon.png rel=icon>
</head>
<body>
<header class=site>
<h1><a href=https://uthark.github.io/>Oleg Atamanenko</a></h1>
<h2>thoughts about programming</h2>
</header>
<nav>
<ul class=main-navigation>
<li><a href=https://uthark.github.io/ title=Posts>Posts</a></li>
<li><a href=https://uthark.github.io/categories/ title=Categories>Categories</a></li>
<li><a href=https://uthark.github.io/usefularticles/ title=Links>Links</a></li>
<li><a href=https://uthark.github.io/about/ title="About me">About me</a></li>
</ul>
</nav>
<div class=article>
<h1>Deploying in Kubernetes. Checklist.</h1>
<p>While kubernetes is easy to start with, it is quite challenging to master and
know all details. In this post I will provide checklist of important manifest
stanzas that are applicable to most applications that are targeted to run in
production and which are expected to not have downtime during cluster
maintenance and/or application updates.</p>
<p>Deploying to kubernetes is easy: create manifest with your <code>Deployment</code> and then <code>kubectl apply</code> it.</p>
<p>The most basic deployment manifest looks like this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>test-app</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-app</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>test-app</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>test-app</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>controller</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></code></pre></div><p>It works as is, but you may improve reliability of this deployment by configuring additional fields for the manifest.</p>
<h2 id=metadata>Metadata</h2>
<p>Use <code>metadata</code> field efficiently. You can add labels who owns the deployment, if they are part of the bigger project, and so on.
This will allow to discover all deployments that are owned by a specific department:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>kubectl get deploy -n production -l department=marketing
</code></pre></div><h2 id=cpumemory-requestsresources>CPU/Memory Requests/Resources</h2>
<p>Correct configuration is important. Requests are used for scheduling (kubelet reports node configuration to scheduler and scheduler uses this information when decides where the pod will be assigned). Limits are used for enforcing usage in runtime.</p>
<h3 id=things-to-remember>Things to remember:</h3>
<ol>
<li>If you go over memory limit, app will be OOMKilled.</li>
<li>If you go over CPU limit, app will be throttled. In fact this is more complicated and your app may be throttled before reaching limit, but this is a topic for another post.</li>
<li>The configuration set affects <a href=https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/>Quality of Service</a> for pod.</li>
<li>QoS affects what happens with your pod when kubelet on the node is <a href=https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#best-practices>out of resources</a></li>
</ol>
<h2 id=do-not-use-latest-tag-in-images>Do not use <code>latest</code> tag in images</h2>
<p>I <a href=https://uthark.github.io/post/2020-09-03-docker-best-practices/>spoke about it previously</a>. Use exact version, i.e. <code>nginx:1.19.2</code>. This is better than <code>latest</code>, but even better to use sha256 of the image:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>image: nginx@sha256:9d660d69e53c286fbdd472122b4b583a46e8a27f10515e415d2578f8478b9aad
</code></pre></div><h2 id=update-strategy>Update Strategy</h2>
<p>Default strategy is <code>RollingUpdate</code>. If you run multiple replicas of the application, consider tuning <code>maxUnavailable</code>/<code>maxSurge</code> based on your requirements.
If your app have multiple replicas and each replica requires a lot of CPU/Memory, having <code>maxSurge</code> might require autoscaler to provision extra nodes.</p>
<h2 id=service-accounts>Service Accounts</h2>
<p>By default, each deployment will use <code>default</code> service account. If app requires access to kubernetes API, consider creating separate service account for the app. This will allow improve your isolation and security:</p>
<ol>
<li>Use <a href=https://kubernetes.io/docs/concepts/policy/pod-security-policy/>PodSecurityPolicy</a> for fine-grained authorization of what’s allowed to pod to do on the node.</li>
<li>Use <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>RBAC ClusterRoleBinding/RoleBinding</a> to control permissions for the resources in Kubernetes.</li>
</ol>
<h2 id=securitycontext>SecurityContext</h2>
<p><code>securityContext</code> allows to control security context of the pod. Recommended to enforce <code>runAsNonRoot</code>. <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>See documentation</a></p>
<h2 id=pod-disruption-budget>Pod Disruption Budget</h2>
<p>If you have multiple replicas of the application, create <code>PodDisruptionBudget</code> for the <code>Deployment</code>. See <a href=https://kubernetes.io/docs/tasks/run-application/configure-pdb/>documentation</a> for more details.</p>
<h2 id=liveness--readiness-probes>Liveness & Readiness Probes</h2>
<p>I cannot stress more importance of it. I’ve seen application being taken down when they should not and vice versa. Your biggest nightmare will be if you do a rollout when new pods are crashlooping and olds pods are not terminated when they should.</p>
<h2 id=lifecycle-hook---post-start--pre-stop>Lifecycle Hook - Post Start / Pre Stop</h2>
<p>Lifecycle hooks allows gracefully terminate application. I.e. you can finish current request, save state and then terminate. See <a href=https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/>documentation</a></p>
<h2 id=priority-classes>Priority Classes</h2>
<p>Not all apps are created equal. Some apps are more important. Consider defining priority classes and use appropriate priority class for the application. <a href=https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/ title="Pod Priority and Preemption">Read more in official documentation</a></p>
<h2 id=taints-and-tolerations>Taints and tolerations</h2>
<p>Sometimes there are specific requirements where application should or should not run.
Taints allows to taint nodes to prevent regular workload from scheduling on those node. To allow workload to be scheduled on the nodes - use Tolerations.
<a href=https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/>See documentation</a></p>
<h2 id=affinities-and-anti-affinities>Affinities and anti-affinities</h2>
<p>Affinities and anti-affinities provides you more control where to schedule the workload. For example, you might want to use pod anti-affinity to distribute replicas of the application across different nodes or availability zones. See <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/>documentation</a> for details.
Another great feature that you might need is <a href=https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/>Topology Manager</a> for better allocation of the workload.</p>
<h2 id=references>References</h2>
<p>This is a must read documentation to learn / refresh your knowledge:</p>
<ul>
<li><a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/>Workload - Deployments</a></li>
<li><a href=https://kubernetes.io/docs/concepts/workloads/pods/disruptions/>Workload – Disruptions</a></li>
<li><a href=https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/>Container Lifecycle Hooks</a></li>
<li><a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/>Workload – Pod Lifecycle</a></li>
<li><a href=https://kubernetes.io/docs/concepts/policy/pod-security-policy/>Pod Security Policies</a></li>
<li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>Configure a Security Context for a Pod or Container</a></li>
<li><a href=https://kubernetes.io/docs/tasks/run-application/configure-pdb/>Specifying a Disruption Budget for your Application</a></li>
<li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/>Configure Liveness, Readiness and Startup Probes</a></li>
<li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/>Configure Service Accounts for Pods</a></li>
<li><a href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/>Scheduling and Eviction – Assigning Pods to Nodes</a></li>
<li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></li>
<li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></li>
<li><a href=https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#best-practices>Configure Out of Resource Handling</a></li>
<li><a href=https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/>Topology Manager</a></li>
<li><a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>Using RBAC Authorization</a></li>
<li><a href=https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/ title="Pod Priority and Preemption">Pod Priority and Preemption</a></li>
<li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></li>
<li><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#deployment-v1-apps>apps/v1 Deployment API Reference</a></li>
<li><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#podspec-v1-core>core/v1 PodSpec API Reference</a></li>
</ul>
</div>
<footer>
<div class=social>
<ul>
<li class=sidebar-nav-item><a target=_blank href=https://github.com/uthark/ title=https://github.com/uthark/><i class="fa fa-github fa-2x"></i></a>
</li>
<li class=sidebar-nav-item> <a target=_blank href=https://bitbucket.org/uthark/ title=https://bitbucket.org/uthark/><i class="fa fa-bitbucket fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://twitter.com/real_atamanenko title=https://twitter.com/real_atamanenko><i class="fa fa-twitter fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://keybase.io/uthark/ title=https://keybase.io/uthark/><i class="fa fa-key fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=http://stackoverflow.com/users/216764/uthark title=http://stackoverflow.com/users/216764/uthark><i class="fa fa-stack-overflow fa-2x"></i></a>
</li>
<li><a href=https://feeds.feedburner.com/atamanenko target=_blank type=application/rss+xml title=RSS><i class="fa fa-rss-square fa-2x"></i></a></li>
</ul>
</div>
<p>&copy;&nbsp;2009&nbsp;—&nbsp;2021 Oleg Atamanenko - <a href=https://uthark.github.io/license/>CC&nbsp;BY-SA&nbsp;4.0</a>
</p>
</footer>
<script>var _gaq=[['_setAccount','UA-8688665-1'],['_trackPageview']];(function(b,c){var d=b.createElement(c),a=b.getElementsByTagName(c)[0];a.async='async',d.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js',a.parentNode.insertBefore(d,a)})(document,'script')</script>
</body>
</html>
</body>
</html>