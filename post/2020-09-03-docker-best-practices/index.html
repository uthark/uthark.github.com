<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=5">

  
  <title>Docker Best Practices</title>


  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="Oleg Atamanenko">


  <link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/go-mono" type="text/css"/>
  <link rel="stylesheet" media="screen" href="https://fonts.googleapis.com/css?family=Arvo" type="text/css"/>


  
  
  <link rel="stylesheet" href="https://uthark.github.io/css/uthark.css">

  
  

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  <link href="https://uthark.github.io/favicon.png" rel="icon">

  
  
  


  


  
  <link href="https://feeds.feedburner.com/atamanenko" rel="alternate" type="application/rss+xml" title="Sharing knowledge" />
  

  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@LinkageError">
  <meta name="twitter:creator" content="@LinkageError">

  <meta name="twitter:title" content="Docker Best Practices">

  

  <meta property="og:title" content="Docker Best Practices" />
  <meta property="og:url" content="https://uthark.github.io/post/2020-09-03-docker-best-practices/" />
  <meta property="og:description" content="Introduction After using docker for last several years I’d like to share best practices that works in production.
Reduce container image size In Cloud Native world infrastructure is disposable and immutable. As result, if your kubernetes pod is rescheduled to another node, new node need to pull docker image.
Small docker images provide the following benefits:
 Smaller attack surface. If image contain only your app binaries and direct dependencies without full blown OS, you will need to apply patches to fix vulnerabilities infrequently." />

  




</head>
<body>

<header>
  
  <h1><a href="https://uthark.github.io/">Sharing knowledge</a></h1>
    <h2>by Oleg Atamanenko</h2>
</header>


<nav>

<ul class="main-navigation">
  
  
    
      <li><a href="https://uthark.github.io/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://uthark.github.io/usefularticles/" title="Useful Articles" >Useful Articles</a></li>
    
  
    
      <li><a href="https://uthark.github.io/categories/" title="Categories" >Categories</a></li>
    
  
    
      <li><a href="https://uthark.github.io/readinglist/" title="Reading Lists" >Reading Lists</a></li>
    
  
    
      <li><a href="https://uthark.github.io/about/" title="About" >About</a></li>
    
  
</ul>


<ul class="subscription">
  
    
        
        
        <li><a href="https://feeds.feedburner.com/atamanenko" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a></li>
        

    
  

</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" placeholder="Search"/>
    <input type="hidden" name="q" value="site:https://uthark.github.io/" />
  </fieldset>
</form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry">

        
        
<div class="sharing">
    <a href="https://getpocket.com/save?url=https%3a%2f%2futhark.github.io%2fpost%2f2020-09-03-docker-best-practices%2f" target="_blank" ><i class="fa fa-get-pocket" title="Save to Pocket" aria-hidden="true"></i></a>
    <a href="https://twitter.com/intent/tweet?text=Docker%20Best%20Practices&url=https%3a%2f%2futhark.github.io%2fpost%2f2020-09-03-docker-best-practices%2f" target="_blank" title="Post to Twitter" aria-hidden="true"><i class="fa fa-twitter"></i></a>
</div>
<header>
    <h1 class="entry-title">
         Docker Best Practices 
    </h1>

</header>


        <div class="entry-content">
          
          
          
          
          <h2 id="introduction">Introduction</h2>
<p>After using docker for last several years I’d like to share best practices that works in production.</p>
<h2 id="reduce-container-image-size">Reduce container image size</h2>
<p>In Cloud Native world infrastructure is disposable and immutable. As result, if your kubernetes pod is rescheduled to another node, new node need to pull docker image.</p>
<p>Small docker images provide the following benefits:</p>
<ol>
<li>Smaller attack surface. If image contain only your app binaries and direct dependencies without full blown OS, you will need to apply patches to fix vulnerabilities infrequently.</li>
<li>Faster application startup. Your container runtime will download image faster.</li>
<li>Less network utilization. You will reduce your network bandwidth utilization.</li>
<li>Less cost. Smaller images take less space. In modern cloud days you pay for the storage, using less space saves you money.</li>
</ol>
<h3 id="how">How?</h3>
<p>There are several techniques to reduce image size:</p>
<ol>
<li>Use <a href="https://github.com/GoogleContainerTools/distroless">distroless</a> base images. &ldquo;Distroless&rdquo; images contain only your application and its runtime dependencies. They do not contain package managers, shells or any other programs you would expect to find in a standard Linux distribution.</li>
<li>If you need basic shell, try to use <a href="https://hub.docker.com/_/busybox">busybox</a> or try using <a href="https://hub.docker.com/_/alpine">alpine</a> – this is minimalistic linux distribution. One caveat is that you might need to pass extra flags for app during compilation to make it compatible with alpine.</li>
<li><a href="https://docs.docker.com/develop/develop-images/multistage-build/">Use multi-stage builds</a>. This will allow you to build image in one container and the copy resulting binaries in a final image that doesn’t have compiler tools, source code and other data. Using multistage builds allows you to not use all commands in a single <code>RUN</code> stanza in <code>Dockerfile</code>, which improves source code readability</li>
</ol>
<h2 id="security-is-important">Security is important</h2>
<p>Principle of least privilege should be used as much as possible. Within its cgroup docker container runs as root. If there is a new kernel vulnerability, malicious container might try to use it and escape to the host using 	<code>root</code> permissions.</p>
<h3 id="how-1">How?</h3>
<ol>
<li>
<p>Set <code>USER</code> in the <code>Dockerfile</code>.</p>
</li>
<li>
<p>Do not use <code>latest</code> in <code>FROM</code>. If you use <code>latest</code>, you will pull latest base image. Downsides of it are the following:</p>
<ol>
<li>If upstream repository is compromised, you might get compromised image with <code>latest</code></li>
<li>If upstream repository bumps version, you might get incompatible version of the software in your image. Dependency updates should be manageable and not happen ad hoc.</li>
</ol>
</li>
<li>
<p>Use digest/<code>@sha256</code> in <code>FROM</code> to specify exact version of the container you’re pulling. Digest is shown on tag page on docker hub or you can get it after running <code>docker pull</code>:</p>
<pre><code>      ```
      $ docker pull alpine:3.12.0
      3.12.0: Pulling from library/alpine
      df20fa9351a1: Pull complete
      Digest: sha256:185518070891758909c9f839cf4ca393ee977ac378609f700f60a771a2dfe321
      Status: Downloaded newer image for alpine:3.12.0
      docker.io/library/alpine:3.12.0
      ```

 `Dockerfile` will looks like this:
	
 ```
 FROM alpine@sha256:185518070891758909c9f839cf4ca393ee977ac378609f700f60a771a2dfe321
 COPY ...
 # And so on.
 ``` 
</code></pre>
<ol start="4">
<li>Use own docker registry. Rebuild all required base images yourself and use them. This will allow you to control which base image are being used.</li>
<li>Prohibit running docker containers from <code>docker.io</code> in production. If you run in kubernetes, use <a href="https://github.com/open-policy-agent/gatekeeper">Open Policy Agent Gatekeeper</a> or similar solution. docker.io contains a lot of images that are build both by well-known companies and by random people, not all of them have good intentions.</li>
</ol>
</li>
</ol>
<h2 id="improve-maintainability">Improve maintainability</h2>
<ol>
<li>Add <a href="https://docs.docker.com/engine/reference/builder/#label"><code>LABEL</code></a> with information about image maintainer and other information that is relevant for your organization.</li>
<li>Use <a href="https://docs.docker.com/engine/reference/builder/#arg"><code>ARG</code></a> to pass base IMAGE. This will allow you to configure base image outside and give you ability to manage base image at scale if you have large organization/have hundreds of different images.</li>
</ol>

        </div>
        

<footer>
  <div>
    <p>If you have any questions, feel free to ping me on Twitter.</p>
  </div>
  <p class="meta">
    
    
    
    
    Filed under: <a class="label"
      href="https://uthark.github.io/categories/bestpractices/">bestpractices</a><a class="label"
      href="https://uthark.github.io/categories/docker/">docker</a><a class="label"
      href="https://uthark.github.io/categories/development/">development</a>
    
  </p>

  <p class="meta">
    
    Last update: <time datetime="2020-09-03">Sep 3, 2020</time>

    
  <div>
    <span class="categories">
      Tags:
      
      <a class="category" href="https://uthark.github.io/tags/docker/">docker</a>
      <a class="category" href="https://uthark.github.io/tags/bestpractices/">bestpractices</a>
      
    </span>
  </div>
  
  </p>
  


  

  <p class="meta">
    
    <a class="basic-alignment left" href="https://uthark.github.io/post/2020-09-02-installing-kubernetes-raspberrypi/" title="Installing Kubernetes on Raspberry Pi">&lt;&lt;&nbsp;Installing Kubernetes on Raspberry Pi</a>
    

    
  </p>
  
  
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "uthark" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  
  
</footer>
      </article>
      
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>


<section class="even">
  <div class="toc-header">Table of Contents</div>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#reduce-container-image-size">Reduce container image size</a>
      <ul>
        <li><a href="#how">How?</a></li>
      </ul>
    </li>
    <li><a href="#security-is-important">Security is important</a>
      <ul>
        <li><a href="#how-1">How?</a></li>
      </ul>
    </li>
    <li><a href="#improve-maintainability">Improve maintainability</a></li>
  </ul>
</nav>
</section>





  

  

  
  
  

</aside>

  </div>
</div>

<footer>
    
    <div class="center">
        <ul class="sidebar-nav">
            <li class="sidebar-nav-item">
                <a target="_blank" href="https://github.com/uthark/" title="https://github.com/uthark/"><i
                    class="fa fa-github fa-3x"></i></a></li>
            <li class="sidebar-nav-item">    <a target="_blank" href="https://bitbucket.org/uthark/" title="https://bitbucket.org/uthark/"><i
                    class="fa fa-bitbucket fa-3x"></i></a>
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item"><a target="_blank" href="#ZgotmplZ" title="map[card:summary creator:@LinkageError site:@LinkageError]"><i
                    class="fa fa-twitter fa-3x"></i></a>
            <li class="sidebar-nav-item"><a target="_blank" href="https://keybase.io/uthark/" title="https://keybase.io/uthark/"><i
                    class="fa fa-key fa-3x"></i></a> 
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item"><a target="_blank" href="http://stackoverflow.com/users/216764/uthark" title="http://stackoverflow.com/users/216764/uthark"><i
                    class="fa fa-stack-overflow fa-3x"></i></a>
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
                
                
            </li>
        </ul>
    </div>
    <p>Copyright &copy; 2009&nbsp;—&nbsp;2020 Oleg Atamanenko - <a href="https://uthark.github.io/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a>, uses custom theme based on
            <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.</span>
    </p>

</footer>


<script>
    var _gaq = [['_setAccount', 'UA-8688665-1'], ['_trackPageview']];
    (function (d, t) {
        var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
        s.async = 'async'
        g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g, s)
    }(document, 'script'));
</script>


</body>
</html>

