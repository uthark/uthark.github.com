<!doctype html><html>
<head>
<meta charset=utf-8>
<title>
Docker Best Practices &ndash; Oleg Atamanenko
</title>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=theme-color content="#333" media="(prefers-color-scheme: dark)">
<meta name=theme-color content="#777" media="(prefers-color-scheme: light)">
<meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1">
<link rel=stylesheet media=screen href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300&family=Prata&display=swap" type=text/css>
<link rel=stylesheet href=https://uthark.github.io/css/theme.72254bdf9ec9fc2d8b013dd5c21997b2ab476af1a37ded5995aae71c4a63d57d.css>
<link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css>
<link href=https://uthark.github.io/favicon.png rel=icon>
</head>
<body>
<header class=site>
<h1><a href=https://uthark.github.io/>Oleg Atamanenko</a></h1>
<h2>thoughts about programming</h2>
</header>
<nav>
<ul class=main-navigation>
<li><a href=https://uthark.github.io/ title=Posts>Posts</a></li>
<li><a href=https://uthark.github.io/categories/ title=Categories>Categories</a></li>
<li><a href=https://uthark.github.io/usefularticles/ title=Links>Links</a></li>
<li><a href=https://uthark.github.io/about/ title="About me">About me</a></li>
</ul>
</nav>
<div class=article>
<h1>Docker Best Practices</h1>
<h2 id=introduction>Introduction</h2>
<p>After using docker for last several years I’d like to share best practices that works in production.</p>
<h2 id=reduce-container-image-size>Reduce container image size</h2>
<p>In Cloud Native world infrastructure is disposable and immutable. As result, if your kubernetes pod is rescheduled to another node, new node need to pull docker image.</p>
<p>Small docker images provide the following benefits:</p>
<ol>
<li>Smaller attack surface. If image contain only your app binaries and direct dependencies without full blown OS, you will need to apply patches to fix vulnerabilities infrequently.</li>
<li>Faster application startup. Your container runtime will download image faster.</li>
<li>Less network utilization. You will reduce your network bandwidth utilization.</li>
<li>Less cost. Smaller images take less space. In modern cloud days you pay for the storage, using less space saves you money.</li>
</ol>
<h3 id=how>How?</h3>
<p>There are several techniques to reduce image size:</p>
<ol>
<li>Use <a href=https://github.com/GoogleContainerTools/distroless>distroless</a> base images. &ldquo;Distroless&rdquo; images contain only your application and its runtime dependencies. They do not contain package managers, shells or any other programs you would expect to find in a standard Linux distribution.</li>
<li>If you need basic shell, try to use <a href=https://hub.docker.com/_/busybox>busybox</a> or try using <a href=https://hub.docker.com/_/alpine>alpine</a> – this is minimalistic linux distribution. One caveat is that you might need to pass extra flags for app during compilation to make it compatible with alpine.</li>
<li><a href=https://docs.docker.com/develop/develop-images/multistage-build/>Use multi-stage builds</a>. This will allow you to build image in one container and the copy resulting binaries in a final image that doesn’t have compiler tools, source code and other data. Using multistage builds allows you to not use all commands in a single <code>RUN</code> stanza in <code>Dockerfile</code>, which improves source code readability</li>
</ol>
<h2 id=security-is-important>Security is important</h2>
<p>Principle of least privilege should be used as much as possible. Within its cgroup docker container runs as root. If there is a new kernel vulnerability, malicious container might try to use it and escape to the host using <code>root</code> permissions.</p>
<h3 id=how-1>How?</h3>
<ol>
<li>
<p>Set <code>USER</code> in the <code>Dockerfile</code>.</p>
</li>
<li>
<p>Do not use <code>latest</code> in <code>FROM</code>. If you use <code>latest</code>, you will pull latest base image. Downsides of it are the following:</p>
<ol>
<li>If upstream repository is compromised, you might get compromised image with <code>latest</code></li>
<li>If upstream repository bumps version, you might get incompatible version of the software in your image. Dependency updates should be manageable and not happen ad hoc.</li>
</ol>
</li>
<li>
<p>Use digest/<code>@sha256</code> in <code>FROM</code> to specify exact version of the container you’re pulling. Digest is shown on tag page on docker hub or you can get it after running <code>docker pull</code>:</p>
</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash> $ docker pull alpine:3.12.0
 3.12.0: Pulling from library/alpine
 df20fa9351a1: Pull <span class=nb>complete</span>
 Digest: sha256:185518070891758909c9f839cf4ca393ee977ac378609f700f60a771a2dfe321
 Status: Downloaded newer image <span class=k>for</span> alpine:3.12.0
 docker.io/library/alpine:3.12.0
</code></pre></div><p><code>Dockerfile</code> will looks like this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=k>FROM</span><span class=s> alpine@sha256:185518070891758909c9f839cf4ca393ee977ac378609f700f60a771a2dfe321</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> ...<span class=err>
</span><span class=err></span><span class=c># And so on.</span><span class=err>
</span></code></pre></div><ol start=4>
<li>Use own docker registry. Rebuild all required base images yourself and use them. This will allow you to control which base image are being used.</li>
<li>Prohibit running docker containers from <code>docker.io</code> in production. If you run in kubernetes, use <a href=https://github.com/open-policy-agent/gatekeeper>Open Policy Agent Gatekeeper</a> or similar solution. docker.io contains a lot of images that are build both by well-known companies and by random people, not all of them have good intentions.</li>
<li>Do not store any sensitive information in the image. No passwords, no cloud credentials. Pass them either via mounted volume or via <code>ENV</code> variables.</li>
</ol>
<h2 id=improve-maintainability>Improve maintainability</h2>
<ol>
<li>Add <a href=https://docs.docker.com/engine/reference/builder/#label><code>LABEL</code></a> with information about image maintainer and other information that is relevant for your organization.</li>
<li>Use <a href=https://docs.docker.com/engine/reference/builder/#arg><code>ARG</code></a> to pass base IMAGE. This will allow you to configure base image outside and give you ability to manage base image at scale if you have large organization/have hundreds of different images.</li>
</ol>
</div>
<footer>
<div class=social>
<ul>
<li class=sidebar-nav-item><a target=_blank href=https://github.com/uthark/ title=https://github.com/uthark/><i class="fa fa-github fa-2x"></i></a>
</li>
<li class=sidebar-nav-item> <a target=_blank href=https://bitbucket.org/uthark/ title=https://bitbucket.org/uthark/><i class="fa fa-bitbucket fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://twitter.com/real_atamanenko title=https://twitter.com/real_atamanenko><i class="fa fa-twitter fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://keybase.io/uthark/ title=https://keybase.io/uthark/><i class="fa fa-key fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=http://stackoverflow.com/users/216764/uthark title=http://stackoverflow.com/users/216764/uthark><i class="fa fa-stack-overflow fa-2x"></i></a>
</li>
<li><a href=https://feeds.feedburner.com/atamanenko target=_blank type=application/rss+xml title=RSS><i class="fa fa-rss-square fa-2x"></i></a></li>
</ul>
</div>
<p>&copy;&nbsp;2009&nbsp;—&nbsp;2021 Oleg Atamanenko - <a href=https://uthark.github.io/license/>CC&nbsp;BY-SA&nbsp;4.0</a>
</p>
</footer>
<script>var _gaq=[['_setAccount','UA-8688665-1'],['_trackPageview']];(function(b,c){var d=b.createElement(c),a=b.getElementsByTagName(c)[0];a.async='async',d.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js',a.parentNode.insertBefore(d,a)})(document,'script')</script>
</body>
</html>
</body>
</html>