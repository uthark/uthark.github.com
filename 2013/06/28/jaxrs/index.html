<!doctype html><html>
<head>
<meta charset=utf-8>
<title>
JAX-RS Client API &ndash; Oleg Atamanenko
</title>
<link rel=stylesheet media=screen href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300&family=Prata&display=swap" type=text/css>
<link rel=stylesheet href=https://uthark.github.io/css/theme.6e6c1b2c79e89e36c8ab0a167a615efa6b0320017c80244b0c72043ea3ac4bcf.css>
<link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css>
<link href=https://uthark.github.io/favicon.png rel=icon>
</head>
<body>
<header class=site>
<h1><a href=https://uthark.github.io/>Oleg Atamanenko</a></h1>
<h2>thoughts about programming</h2>
</header>
<nav>
<ul class=main-navigation>
<li><a href=https://uthark.github.io/ title=Posts>Posts</a></li>
<li><a href=https://uthark.github.io/categories/ title=Categories>Categories</a></li>
<li><a href=https://uthark.github.io/usefularticles/ title=Links>Links</a></li>
<li><a href=https://uthark.github.io/about/ title="About me">About me</a></li>
</ul>
</nav>
<div class=article>
<h1>JAX-RS Client API</h1>
<p><a href="http://jcp.org/en/jsr/detail?id=339">JAX-RS</a> - набор Java API для работы с REST сервисами. Существует несколько реализаций, <a href=/blog/2012/02/08/java-rest/>о которых я уже писал раньше</a>.</p>
<p>Предположим, что проект А выставляет наружу REST API, который мы хотим использовать в проекте Б. Очевидно, что сразу возникает вопрос - можно ли переиспользовать классы модели и интерфейс в другом проекте. Ответ - да, можно. Client API, появившийся в JAX RS 2.0, упрощает реализацию клиента, но это всё равно не самый оптимальный вариант.</p>
<p>Есть более интересный способ - в замечательной библиотеке <a href=http://cxf.apache.org/>Apache CXF</a> есть класс <a href=http://cxf.apache.org/javadoc/latest/org/apache/cxf/jaxrs/client/JAXRSClientFactory.html><code>org.apache.cxf.jaxrs.client.JAXRSClientFactory</code></a>, который позволяет автоматически получать прокси-клиент для работы с сервером.</p>
<p>К сожалению, у меня не получилось завести его с JSON без JAXB - Проблема с Generic Collections - <a href=http://cxf.apache.org/javadoc/latest/org/apache/cxf/jaxrs/provider/json/JSONProvider.html><code>org.apache.cxf.jaxrs.provider.json.JSONProvider</code></a> подразумевает, что в проекте используется JAXB, с помощью которого у нас проаннотирована модель. Поэтому пришлось написать собственную реализацию <a href=http://docs.oracle.com/javaee/6/api/javax/ws/rs/ext/MessageBodyReader.html><code>javax.ws.rs.ext.MessageBodyReader&lt;T></code></a> и <a href=http://docs.oracle.com/javaee/6/api/javax/ws/rs/ext/MessageBodyWriter.html>javax.ws.rs.ext.MessageBodyWriter<t></a>.</p>
<p>Основная проблема при работе с JSON - это то, что, в общем случае, у нас нет информации об используемых типах данных, а вкупе с тем, что в Java Generics реализованы с <a href=http://docs.oracle.com/javase/tutorial/java/generics/erasure.html>Type Erasure</a> - ситуация усугубляется, если не предпринять каких-то действий.</p>
<p>Для реализации чтения будем использовать <a href=http://jackson.codehaus.org/Home>Jackson Java JSON-processor</a> и его возможности <a href=http://fasterxml.github.io/jackson-databind/javadoc/2.2.0/com/fasterxml/jackson/databind/type/TypeFactory.html><code>com.fasterxml.jackson.databind.type.TypeFactory</code></a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>JsonMessageHandler</span> <span class=kd>implements</span> <span class=n>MessageBodyReader</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;,</span> <span class=n>MessageBodyWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=o>{</span>

    <span class=kd>protected</span> <span class=kd>final</span> <span class=n>ObjectMapper</span> <span class=n>mapper</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>JsonMessageHandler</span><span class=o>(</span><span class=n>ObjectMapper</span> <span class=n>mapper</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>mapper</span> <span class=o>=</span> <span class=n>mapper</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isReadable</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>type</span><span class=o>,</span> <span class=n>Type</span> <span class=n>genericType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>MediaType</span> <span class=n>mediaType</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>readFrom</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>type</span><span class=o>,</span> <span class=n>Type</span> <span class=n>genericType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>MediaType</span> <span class=n>mediaType</span><span class=o>,</span> <span class=n>MultivaluedMap</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>httpHeaders</span><span class=o>,</span> <span class=n>InputStream</span> <span class=n>entityStream</span><span class=o>)</span>
            <span class=kd>throws</span> <span class=n>IOException</span><span class=o>,</span> <span class=n>WebApplicationException</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>genericType</span> <span class=k>instanceof</span> <span class=n>ParameterizedType</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>Collection</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>type</span><span class=o>))</span> <span class=o>{</span>
                <span class=n>CollectionType</span> <span class=n>collectionType</span> <span class=o>=</span> <span class=n>resolveCollectionType</span><span class=o>(</span><span class=n>type</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>genericType</span><span class=o>);</span>
                <span class=k>return</span> <span class=n>mapper</span><span class=o>.</span><span class=na>readValue</span><span class=o>(</span><span class=n>entityStream</span><span class=o>,</span> <span class=n>collectionType</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>type</span><span class=o>))</span> <span class=o>{</span>
                <span class=n>MapType</span> <span class=n>mapType</span> <span class=o>=</span> <span class=n>resolveMapType</span><span class=o>(</span><span class=n>type</span><span class=o>,</span> <span class=o>(</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>genericType</span><span class=o>);</span>
                <span class=k>return</span> <span class=n>mapper</span><span class=o>.</span><span class=na>readValue</span><span class=o>(</span><span class=n>entityStream</span><span class=o>,</span> <span class=n>mapType</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
                <span class=n>Type</span><span class=o>[]</span> <span class=n>actualTypeArguments</span> <span class=o>=</span> <span class=o>((</span><span class=n>ParameterizedType</span><span class=o>)</span> <span class=n>genericType</span><span class=o>).</span><span class=na>getActualTypeArguments</span><span class=o>();</span>
                <span class=n>Class</span><span class=o>[]</span> <span class=n>typeArgs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Class</span><span class=o>[</span><span class=n>actualTypeArguments</span><span class=o>.</span><span class=na>length</span><span class=o>];</span>
                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>actualTypeArguments</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
                    <span class=n>Type</span> <span class=n>actualTypeArgument</span> <span class=o>=</span> <span class=n>actualTypeArguments</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
                    <span class=n>typeArgs</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=o>(</span><span class=n>Class</span><span class=o>)</span> <span class=n>actualTypeArgument</span><span class=o>;</span>
                <span class=o>}</span>
                <span class=n>JavaType</span> <span class=n>javaType</span> <span class=o>=</span>
                        <span class=n>TypeFactory</span><span class=o>.</span><span class=na>defaultInstance</span><span class=o>().</span><span class=na>constructParametricType</span><span class=o>(</span><span class=n>type</span><span class=o>,</span> <span class=n>typeArgs</span><span class=o>);</span>
                <span class=k>return</span> <span class=n>mapper</span><span class=o>.</span><span class=na>readValue</span><span class=o>(</span><span class=n>entityStream</span><span class=o>,</span> <span class=n>javaType</span><span class=o>);</span>
            <span class=o>}</span>

        <span class=o>}</span>

        <span class=k>return</span> <span class=n>mapper</span><span class=o>.</span><span class=na>readValue</span><span class=o>(</span><span class=n>entityStream</span><span class=o>,</span> <span class=n>type</span><span class=o>);</span>

    <span class=o>}</span>

    <span class=kd>private</span> <span class=n>MapType</span> <span class=nf>resolveMapType</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>type</span><span class=o>,</span> <span class=n>ParameterizedType</span> <span class=n>genericType</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>Type</span><span class=o>[]</span> <span class=n>args</span> <span class=o>=</span> <span class=n>genericType</span><span class=o>.</span><span class=na>getActualTypeArguments</span><span class=o>();</span>
        <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Map</span><span class=o>&gt;</span> <span class=n>mapClass</span> <span class=o>=</span> <span class=n>type</span><span class=o>.</span><span class=na>asSubclass</span><span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>TypeFactory</span><span class=o>.</span><span class=na>defaultInstance</span><span class=o>().</span><span class=na>constructMapType</span><span class=o>(</span><span class=n>mapClass</span><span class=o>,</span> <span class=o>(</span><span class=n>Class</span><span class=o>)</span> <span class=n>args</span><span class=o>[</span><span class=n>0</span><span class=o>],</span> <span class=o>(</span><span class=n>Class</span><span class=o>)</span> <span class=n>args</span><span class=o>[</span><span class=n>1</span><span class=o>]);</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=n>CollectionType</span> <span class=nf>resolveCollectionType</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>type</span><span class=o>,</span> <span class=n>ParameterizedType</span> <span class=n>genericType</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>Type</span> <span class=n>type1</span> <span class=o>=</span> <span class=n>genericType</span><span class=o>.</span><span class=na>getActualTypeArguments</span><span class=o>()[</span><span class=n>0</span><span class=o>];</span>
        <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Collection</span><span class=o>&gt;</span> <span class=n>collectionClass</span> <span class=o>=</span> <span class=n>type</span><span class=o>.</span><span class=na>asSubclass</span><span class=o>(</span><span class=n>Collection</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
        <span class=k>return</span> <span class=n>TypeFactory</span><span class=o>.</span><span class=na>defaultInstance</span><span class=o>().</span><span class=na>constructCollectionType</span><span class=o>(</span><span class=n>collectionClass</span><span class=o>,</span> <span class=o>(</span><span class=n>Class</span><span class=o>)</span> <span class=n>type1</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isWriteable</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>type</span><span class=o>,</span> <span class=n>Type</span> <span class=n>genericType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>MediaType</span> <span class=n>mediaType</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>long</span> <span class=nf>getSize</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>type</span><span class=o>,</span> <span class=n>Type</span> <span class=n>genericType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>MediaType</span> <span class=n>mediaType</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=o>-</span><span class=n>1L</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>writeTo</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>type</span><span class=o>,</span> <span class=n>Type</span> <span class=n>genericType</span><span class=o>,</span> <span class=n>Annotation</span><span class=o>[]</span> <span class=n>annotations</span><span class=o>,</span> <span class=n>MediaType</span> <span class=n>mediaType</span><span class=o>,</span> <span class=n>MultivaluedMap</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>httpHeaders</span><span class=o>,</span> <span class=n>OutputStream</span> <span class=n>entityStream</span><span class=o>)</span>
            <span class=kd>throws</span> <span class=n>IOException</span><span class=o>,</span> <span class=n>WebApplicationException</span> <span class=o>{</span>
        <span class=n>mapper</span><span class=o>.</span><span class=na>writeValue</span><span class=o>(</span><span class=n>entityStream</span><span class=o>,</span> <span class=n>o</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>Основной код класса сосредоточен в методе <code>readFrom</code>, который определяет типизацию класса и создаёт необходимый подкласс <code>com.fasterxml.jackson.databind.JavaType</code>, который будет использован во время десериализации.</p>
<p>Теперь мы можем создать клиента следующим образом:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>List</span><span class=o>&lt;?&gt;</span> <span class=n>providers</span> <span class=o>=</span> <span class=n>Arrays</span><span class=o>.</span><span class=na>asList</span><span class=o>(</span><span class=k>new</span> <span class=n>JsonMessageHandler</span><span class=o>(</span><span class=n>objectMapper</span><span class=o>));</span>
<span class=n>UserRest</span> <span class=n>userRest</span> <span class=o>=</span> <span class=n>JAXRSClientFactory</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=s>&#34;http://localhost:8080&#34;</span><span class=o>,</span> <span class=n>UserRest</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>providers</span><span class=o>);</span>

<span class=c1>// usage:
</span><span class=c1></span><span class=n>User</span> <span class=n>user</span> <span class=o>=</span> <span class=n>userRest</span><span class=o>.</span><span class=na>findByLogin</span><span class=o>(</span><span class=s>&#34;uthark&#34;</span><span class=o>);</span>
</code></pre></div><p>Когда вызывается метод <code>findByLogin</code> под капотом создаётся HTTP Request, дёргается сервер и полученный ответ десериализуется. От конечного пользотеля детали реализации API скрыты.</p>
<p>В <a href=/blog/2013/06/28/jaxrs-spring-autowiring/>следующем посте</a> описано, как автоматически добавить полученные прокси в фабрику бинов Spring для дальнейшего использования.</p>
</div>
<footer>
<div class=social>
<ul>
<li class=sidebar-nav-item><a target=_blank href=https://github.com/uthark/ title=https://github.com/uthark/><i class="fa fa-github fa-2x"></i></a>
</li>
<li class=sidebar-nav-item> <a target=_blank href=https://bitbucket.org/uthark/ title=https://bitbucket.org/uthark/><i class="fa fa-bitbucket fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://twitter.com/real_atamanenko title=https://twitter.com/real_atamanenko><i class="fa fa-twitter fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://keybase.io/uthark/ title=https://keybase.io/uthark/><i class="fa fa-key fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=http://stackoverflow.com/users/216764/uthark title=http://stackoverflow.com/users/216764/uthark><i class="fa fa-stack-overflow fa-2x"></i></a>
</li>
<li><a href=https://feeds.feedburner.com/atamanenko target=_blank type=application/rss+xml title=RSS><i class="fa fa-rss-square fa-2x"></i></a></li>
</ul>
</div>
<p>&copy;&nbsp;2009&nbsp;—&nbsp;2021 Oleg Atamanenko - <a href=https://uthark.github.io/license/>CC&nbsp;BY-SA&nbsp;4.0</a>
</p>
</footer>
<script>var _gaq=[['_setAccount','UA-8688665-1'],['_trackPageview']];(function(b,c){var d=b.createElement(c),a=b.getElementsByTagName(c)[0];a.async='async',d.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js',a.parentNode.insertBefore(d,a)})(document,'script')</script>
</body>
</html>
</body>
</html>