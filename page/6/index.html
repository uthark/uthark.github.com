<!DOCTYPE html>
<html prefix="og: https://ogp.me/ns#" lang="en">
<head>
	<meta name="generator" content="Hugo 0.74.3" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
        <link rel="canonical" href="https://uthark.github.io/">
    

    
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=5">

    
    <title>Sharing knowledge</title>

    <meta name="description"
          content="">
    <meta name="keywords"
          content="">

    <meta name="author" content="Oleg Atamanenko">

    <link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/go-mono" type="text/css"/>
    <link rel="stylesheet" media="screen" href="https://fonts.googleapis.com/css?family=Arvo" type="text/css"/>

    
    
    
    <link rel="stylesheet" href="https://uthark.github.io/css/theme.8aa4c0df1ef774abd16737cc5a42115b13a32bb3cb12452197c562bc083b9cbd.css">
    <link rel="stylesheet" href="https://uthark.github.io/css/uthark.css">


    
    

    
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

    
    <link href="https://uthark.github.io/favicon.png" rel="icon">

    
    
    


    


    
        <link href="https://feeds.feedburner.com/atamanenko" rel="alternate" type="application/rss+xml" title="Sharing knowledge"/>
    

    


</head>
<body>

<header class="site">
    
    <h1><a href="https://uthark.github.io/">Sharing knowledge</a></h1>
    <h2>by Oleg Atamanenko</h2>
</header>


<nav>
<div class="menu">
  <input type="checkbox" id="menu" class="fa fa-bars">
  <label for="menu" aria-label="Menu"></label>

  <div class="menu-container">

<ul class="main-navigation">
  
  
    
      <li><a href="https://uthark.github.io/" title="Posts">Posts</a></li>
    
  
    
      <li><a href="https://uthark.github.io/usefularticles/" title="Links" >Links</a></li>
    
  
    
      <li><a href="https://uthark.github.io/categories/" title="Categories" >Categories</a></li>
    
  
    
      <li><a href="https://uthark.github.io/readinglist/" title="Reading Lists" >Reading Lists</a></li>
    
  
    
      <li><a href="https://uthark.github.io/about/" title="About" >About</a></li>
    
  
</ul>


<ul class="subscription">
    
        
            
            
                <li><a href="https://feeds.feedburner.com/atamanenko" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a></li>
            

        
    

</ul>



<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" placeholder="Search"/>
    <input type="hidden" name="q" value="site:https://uthark.github.io/" />
  </fieldset>
</form>

</div>
</div>
</nav>


<div id="main">
 <div id="content">
  <div class="blog-index">
    
    
    <article>

        
        

<header>
    <h1 class="entry-title">
        <a href="https://uthark.github.io/2012/04/24/spring-data-jpa/">Ищем с помощью Spring Data JPA</a>
    </h1>

</header>


        
        <p>Рассмотрим подробнее одну из наиболее полезных вещей в Spring Data JPA - генерация JPQL-запросов на основе имени метода.</p>
<p>Spring Data JPA умеет автоматически генерировать запросы используя для подсказки название метода.</p>
<p>Например, метод <code>User.findByLoginAndPassword</code> сгенерирует примерно следующий код:</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">FROM</span> <span class="k">User</span> <span class="n">u</span> <span class="k">where</span> <span class="n">u</span><span class="p">.</span><span class="n">login</span> <span class="o">=</span> <span class="p">:</span><span class="n">login</span> <span class="k">and</span> <span class="n">password</span> <span class="o">=</span> <span class="p">:</span><span class="n">password</span>
</code></pre></div><p>Вообще Spring Data JPA пытается быть умным, поэтому реализация <!-- raw HTML omitted -->findBy{&hellip;}<!-- raw HTML omitted --> методов ищется следующим образом:</p>
<!-- raw HTML omitted -->
<p>У <!-- raw HTML omitted -->@Query<!-- raw HTML omitted --> следующие плюсы:</p>
<!-- raw HTML omitted -->
<p>Очевидно, что при использовании запросов нам необходимо каким-то образом указывать параметры для запросов. Для этого есть аннотация <!-- raw HTML omitted -->@Param<!-- raw HTML omitted -->:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Query</span><span class="o">(</span><span class="s">&#34;select u from User u where u.login = :login and u.password = :password&#34;</span><span class="o">)</span>
<span class="n">Page</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByLoginAndPassword</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">password</span><span class="o">);</span>
</code></pre></div><p>Кроме того, Spring Data JPA поддерживает отличную <!-- raw HTML omitted -->концепцию спецификаций<!-- raw HTML omitted -->.</p>
<p>Спецификации позволяют делать составлять сложные запросы из набора простых.</p>
<p>Для поддержки спецификаций необходимо объявить метод в репозитории:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Page</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">spec</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</code></pre></div><p>Спецификация по сути является фильтром и позволяет комбинирование фильтров, что даёт мощный инструмент для построения запросов.</p>
<p>Пример использования спецификаций:</p>
<p>Объявляем наши спецификации:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">firstNameOrLastNameOrLoginLike</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">search</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="n">Root</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span> <span class="n">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="n">CriteriaBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>

            <span class="n">Predicate</span> <span class="n">loginPredicate</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">login</span><span class="o">),</span> <span class="n">search</span><span class="o">);</span>
            <span class="n">Predicate</span> <span class="n">firstnamePredicate</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">firstname</span><span class="o">),</span> <span class="n">search</span><span class="o">);</span>
            <span class="n">Predicate</span> <span class="n">lastnamePredicate</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">lastname</span><span class="o">),</span> <span class="n">search</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">loginPredicate</span><span class="o">,</span> <span class="n">firstnamePredicate</span><span class="o">,</span> <span class="n">lastnamePredicate</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">hasRole</span><span class="o">(</span><span class="kd">final</span> <span class="n">Role</span> <span class="n">role</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="n">Root</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span> <span class="n">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="n">CriteriaBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">role</span><span class="o">),</span> <span class="n">role</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></div><p>И в нашем сервисе комбинируем их:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">searchUser</span><span class="o">(</span><span class="n">Role</span> <span class="n">role</span><span class="o">,</span> <span class="n">String</span> <span class="n">search</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Specifications</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">mainSpec</span> <span class="o">=</span> <span class="n">where</span><span class="o">(</span><span class="n">hasRole</span><span class="o">(</span><span class="n">role</span><span class="o">));</span>

    <span class="c1">// уточняем запрос, если была передана строка для поиска
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">search</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">mainSpec</span> <span class="o">=</span> <span class="n">mainSpec</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">firstNameOrLastNameOrLoginLike</span><span class="o">(</span><span class="n">search</span><span class="o">));</span>
    <span class="o">}</span> 

    <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">mainSpec</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
        

    </article>
    
    <article>

        
        

<header>
    <h1 class="entry-title">
        <a href="https://uthark.github.io/2012/04/20/beanpostprocessor/">Использование BeanPostProcessor на примере журналирования</a>
    </h1>

</header>


        
        <p>Сегодня я хочу рассказать, как можно сделать инициализацию логгера в классе с использованием аннотаций и <!-- raw HTML omitted -->BeanPostProcessor<!-- raw HTML omitted --></p>
<p>Очень часто мы инициализируем логгер следующим образом:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClass</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MyClass</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>Я покажу, как сделать, чтобы можно было писать вот так:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Log</span>
<span class="kd">private</span> <span class="n">Logger</span> <span class="n">LOG</span><span class="o">;</span>
</code></pre></div><p>Первым делом нам нужно объявить аннотацию:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">FIELD</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Log</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">category</span><span class="o">()</span> <span class="k">default</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>А вторым делом, написать собственный <!-- raw HTML omitted -->BeanPostProcessor<!-- raw HTML omitted -->, который бы устанавливал нам логгер:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.commons.lang.StringUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanPostProcessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.ReflectionUtils</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggerPostProcessor</span> <span class="kd">implements</span> <span class="n">BeanPostProcessor</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="o">(</span><span class="kd">final</span> <span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">doWithFields</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="k">new</span> <span class="n">FieldProcessor</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">),</span> <span class="k">new</span> <span class="n">LoggerFieldFilter</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FieldProcessor</span> <span class="kd">implements</span> <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">FieldCallback</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">bean</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">FieldProcessor</span><span class="o">(</span><span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">bean</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">beanName</span> <span class="o">=</span> <span class="n">beanName</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doWith</span><span class="o">(</span><span class="n">Field</span> <span class="n">field</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalAccessException</span> <span class="o">{</span>
            <span class="n">Log</span> <span class="n">loggerAnnot</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

            <span class="c1">// Sanity check if annotation is on the field with correct type.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">Logger</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// As user can override logger category - check if it was done.
</span><span class="c1"></span>                <span class="n">String</span> <span class="n">loggerCategory</span> <span class="o">=</span> <span class="n">loggerAnnot</span><span class="o">.</span><span class="na">category</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">loggerCategory</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// use default category instead.
</span><span class="c1"></span>                    <span class="n">loggerCategory</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">loggerCategory</span><span class="o">);</span>
                <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">makeAccessible</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
                <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">logger</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                    <span class="s">&#34;Unable to set logger on field &#39;&#34;</span> <span class="o">+</span> <span class="n">field</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;&#39; in bean &#39;&#34;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
                        <span class="s">&#34;&#39;: field should have class &#34;</span> <span class="o">+</span> <span class="n">Logger</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LoggerFieldFilter</span> <span class="kd">implements</span> <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">FieldFilter</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="n">Field</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span> <span class="o">!=</span> <span class="n">logger</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Если вы используете не <!-- raw HTML omitted -->sfl4j<!-- raw HTML omitted -->, а, например, <!-- raw HTML omitted -->log4j<!-- raw HTML omitted -->, или <!-- raw HTML omitted -->commons-logging<!-- raw HTML omitted -->, то нужно немного поправить код внутри метода <!-- raw HTML omitted -->doWith<!-- raw HTML omitted --></p>
<p>Попутно, данный код показывает пример использования класса <!-- raw HTML omitted -->org.springframework.util.ReflectionUtils<!-- raw HTML omitted -->.</p>

        

    </article>
    
    <article>

        
        

<header>
    <h1 class="entry-title">
        <a href="https://uthark.github.io/2012/04/20/blog-post/">Преобразуем строку в дату</a>
    </h1>

</header>


        
        <p>Казалось бы, есть простейшая задача - преобразовать строковое представление даты в объект класса <!-- raw HTML omitted -->java.util.Date<!-- raw HTML omitted -->.</p>
<p>Как оказалось, иногда использование DateFormat не помогает. В случае, если строка - это заголовок <!-- raw HTML omitted -->Date<!-- raw HTML omitted --> из письма, то нам нужно использовать <!-- raw HTML omitted --><a href="http://docs.oracle.com/javaee/5/api/javax/mail/internet/MailDateFormat.html">javax.mail.internet.MailDateFormat</a><!-- raw HTML omitted --> для преобразования такой строки.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">String</span> <span class="n">dateStr</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Date</span> <span class="n">parsedDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MailDateFormat</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">dateStr</span><span class="o">);</span>
</code></pre></div>
        

    </article>
    
    <article>

        
        

<header>
    <h1 class="entry-title">
        <a href="https://uthark.github.io/2012/02/23/jpa-spring-data-jpa/">Упрощаем работу с JPA при помощи Spring Data JPA</a>
    </h1>

</header>


        
        <!-- raw HTML omitted -->
<p>Несмотря на то, что проект только недавно достиг версии 1.0, у него достаточно богатая история - раньше он развивался в рамках проекта <!-- raw HTML omitted -->Hades<!-- raw HTML omitted -->.</p>
<!-- raw HTML omitted -->
<p>Итак, для начала нам необходимо объявить DAO-интерфейс, в котором мы будем объявлять методы для работы с сущностью.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="o">{</span>
<span class="o">}</span>

</code></pre></div><p>Данного кода достаточно для обычного DAO с <!-- raw HTML omitted -->CRUD<!-- raw HTML omitted -->-методами.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Полный список методов, объявленный в CrudRepository можно посмотреть в <!-- raw HTML omitted -->javadoc<!-- raw HTML omitted -->.</p>
<p>В случае, если нам нужны не все методы, то есть возможность произвести наследование от интерфейса <!-- raw HTML omitted -->Repository<!-- raw HTML omitted --> и перенести в наследника только те методы из интерфейса CrudRepository, которые нужны.</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">Page</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">User</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">findAll</span><span class="o">(</span><span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

</code></pre></div><p>Интерфейс <!-- raw HTML omitted -->Pageable<!-- raw HTML omitted --> инкапсулирует в себе сведения о номере запрашиваемой страницы, размере страницы, а также требуемой сортировке.</p>
<!-- raw HTML omitted -->
<p>Например, нам нужен методы для поиска пользователя по логину и по его e-mail адресу:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">User</span> <span class="nf">findByLogin</span><span class="o">(</span><span class="n">String</span> <span class="n">login</span><span class="o">);</span>
 <span class="n">User</span> <span class="nf">findByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">);</span>
</code></pre></div><p>Все просто.</p>
<p>В случае, если нужны более сложные условия для поиска, то и это тоже реализовано.</p>
<p>Spring Data поддерживает следующие операторы:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Если необходимо, чтобы в результатах поиска было несколько сущностей, то необходимо называть метод find<!-- raw HTML omitted -->All<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/users&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">UserController</span><span class="o">(</span><span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">userRepository</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/{id}&#34;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">showUserForm</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    
    <span class="c1">// Do null check for id
</span><span class="c1"></span>    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="c1">// Do null check for user
</span><span class="c1"></span>    <span class="c1">// Populate model
</span><span class="c1"></span>    <span class="k">return</span> <span class="s">&#34;user&#34;</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Во-первых, вы объявляете зависимость на DAO, а во-вторых всегда вызываете метод <!-- raw HTML omitted -->findOne()<!-- raw HTML omitted --> для загрузки сущности. К счастью, Spring позволяет нам преобразовывать строковые значения из HTTP-запросов в любой нужный тип используя либо <!-- raw HTML omitted --><!-- raw HTML omitted -->PropertyEditor<!-- raw HTML omitted --><!-- raw HTML omitted -->, либо <!-- raw HTML omitted --><!-- raw HTML omitted -->ConversionService<!-- raw HTML omitted --><!-- raw HTML omitted -->.</p>
<p>Если вы используете Spring версии 3.0 и выше, то вам необходимо добавить следующую конфигурацию:</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ni">&amp;lt;</span>mvc:annotation-driven conversion-service=&#34;conversionService&#34; /<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>bean id=&#34;conversionService&#34; class=&#34;<span class="ni">&amp;#8230;</span>.context.support.ConversionServiceFactoryBean&#34;<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>property name=&#34;converters&#34;<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>list<span class="ni">&amp;gt;</span>
      <span class="ni">&amp;lt;</span>bean class=&#34;org.springframework.data.repository.support.DomainClassConverter&#34;<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>constructor-arg ref=&#34;conversionService&#34; /<span class="ni">&amp;gt;</span>
      <span class="ni">&amp;lt;</span>/bean<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>/list<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>/property<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/bean<span class="ni">&amp;gt;</span>
</code></pre></div><p>Если же вы используете Spring более старой версии, то вам необходима вот такая конфигурация:</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ni">&amp;lt;</span>bean class=&#34;<span class="ni">&amp;#8230;</span>.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&#34;<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>property name=&#34;webBindingInitializer&#34;<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>bean class=&#34;<span class="ni">&amp;#8230;</span>.web.bind.support.ConfigurableWebBindingInitializer&#34;<span class="ni">&amp;gt;</span>
      <span class="ni">&amp;lt;</span>property name=&#34;propertyEditorRegistrars&#34;<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>bean class=&#34;org.springframework.data.repository.support.DomainClassPropertyEditorRegistrar&#34; /<span class="ni">&amp;gt;</span>
      <span class="ni">&amp;lt;</span>/property<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>/bean<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>/property<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/bean<span class="ni">&amp;gt;</span>
</code></pre></div><p>После данных изменений в конфигурации можно переписать контроллер следующим образом:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/users&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/{id}&#34;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">showUserForm</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// Do null check for user
</span><span class="c1"></span>    <span class="c1">// Populate model
</span><span class="c1"></span>    <span class="k">return</span> <span class="s">&#34;userForm&#34;</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Обратите внимание на то, как упростился код и как мы красиво избавились от его дублирования.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->

        

    </article>
    
    <article>

        
        

<header>
    <h1 class="entry-title">
        <a href="https://uthark.github.io/2012/02/09/java-rest/">Разработка и тестирование Java REST веб-сервисов</a>
    </h1>

</header>


        
        <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="kn">import</span> <span class="nn">javax.ws.rs.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.MediaType</span><span class="o">;</span>

<span class="nd">@Path</span><span class="o">(</span><span class="s">&#34;/service/entity&#34;</span><span class="o">)</span>
<span class="nd">@Produces</span><span class="o">({</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_XML</span><span class="o">,</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EntityRestService</span> <span class="o">{</span>

 <span class="nd">@GET</span>
 <span class="nd">@Path</span><span class="o">(</span><span class="s">&#34;/all&#34;</span><span class="o">)</span>
 <span class="n">EntityList</span> <span class="nf">listAll</span><span class="o">();</span>

 <span class="nd">@GET</span>
 <span class="nd">@Path</span><span class="o">(</span><span class="s">&#34;/{id}&#34;</span><span class="o">)</span>
 <span class="n">Entity</span> <span class="nf">findById</span><span class="o">(</span><span class="nd">@PathParam</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>


<span class="o">}</span>
</code></pre></div><p>Создаём интерфейс, в котором расставляем JAX-RS аннотации. Аннотация <!-- raw HTML omitted -->@Path<!-- raw HTML omitted --> указывает путь, по которому будет доступен наш сервис. Аннотация <!-- raw HTML omitted -->@GET<!-- raw HTML omitted --> определяет, какой HTTP-запрос будет обрабатываться данным методом. Аннотация <!-- raw HTML omitted -->@Produces<!-- raw HTML omitted --> позволяет указать, в каком формате данный сервис предоставляет результаты.</p>
<!-- raw HTML omitted -->
<p>Конфигурация очень проста, во-первых, нам нужно добавить обновить <!-- raw HTML omitted -->pom.xml<!-- raw HTML omitted --> и добавить необходимые зависимости:</p>
<!-- raw HTML omitted -->
<p>Добавляем compile-time зависимость на JAX-RS API</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.jboss.resteasy<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>jaxrs-api<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
</code></pre></div><p>и runtime зависимости на реализацию</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.jboss.resteasy<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>resteasy-jaxrs<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>version<span class="ni">&amp;gt;</span>${resteasy-jaxrs.version}<span class="ni">&amp;lt;</span>/version<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>scope<span class="ni">&amp;gt;</span>runtime<span class="ni">&amp;lt;</span>/scope<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.jboss.resteasy<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>resteasy-jackson-provider<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>version<span class="ni">&amp;gt;</span>${resteasy-jaxrs.version}<span class="ni">&amp;lt;</span>/version<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>scope<span class="ni">&amp;gt;</span>runtime<span class="ni">&amp;lt;</span>/scope<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>

</code></pre></div><!-- raw HTML omitted -->
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"> <span class="ni">&amp;lt;</span>listener<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>listener-class<span class="ni">&amp;gt;</span>org.jboss.resteasy.plugins.server.servlet.ResteasyBootstrap<span class="ni">&amp;lt;</span>/listener-class<span class="ni">&amp;gt;</span>
 <span class="ni">&amp;lt;</span>/listener<span class="ni">&amp;gt;</span>

 <span class="ni">&amp;lt;</span>context-param<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>param-name<span class="ni">&amp;gt;</span>resteasy.servlet.mapping.prefix<span class="ni">&amp;lt;</span>/param-name<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>param-value<span class="ni">&amp;gt;</span>/rest<span class="ni">&amp;lt;</span>/param-value<span class="ni">&amp;gt;</span>
 <span class="ni">&amp;lt;</span>/context-param<span class="ni">&amp;gt;</span>
 <span class="ni">&amp;lt;</span>servlet<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>servlet-name<span class="ni">&amp;gt;</span>REST Easy<span class="ni">&amp;lt;</span>/servlet-name<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>servlet-class<span class="ni">&amp;gt;</span>org.jboss.resteasy.plugins.server.servlet.HttpServletDispatcher<span class="ni">&amp;lt;</span>/servlet-class<span class="ni">&amp;gt;</span>
 <span class="ni">&amp;lt;</span>/servlet<span class="ni">&amp;gt;</span>
 <span class="ni">&amp;lt;</span>servlet-mapping<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>servlet-name<span class="ni">&amp;gt;</span>REST Easy<span class="ni">&amp;lt;</span>/servlet-name<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>url-pattern<span class="ni">&amp;gt;</span>/rest/*<span class="ni">&amp;lt;</span>/url-pattern<span class="ni">&amp;gt;</span>
 <span class="ni">&amp;lt;</span>/servlet-mapping<span class="ni">&amp;gt;</span>
</code></pre></div><p>Данный код объявляет <!-- raw HTML omitted -->сервлет HttpServletDispatcher<!-- raw HTML omitted -->, который будет обрабатывать все запросы, которые приходят на <!-- raw HTML omitted -->/rest/*<!-- raw HTML omitted -->. Слушатель <!-- raw HTML omitted --><!-- raw HTML omitted -->ResteasyBootstrap<!-- raw HTML omitted --><!-- raw HTML omitted --> выполняет всю необходимую инициализацию JBoss RESTEasy.</p>
<!-- raw HTML omitted -->
<ol>
<li>Добавить зависимость в <!-- raw HTML omitted -->pom.xml<!-- raw HTML omitted --></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.jboss.resteasy<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>resteasy-spring<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>version<span class="ni">&amp;gt;</span>${resteasy-jaxrs.version}<span class="ni">&amp;lt;</span>/version<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>scope<span class="ni">&amp;gt;</span>runtime<span class="ni">&amp;lt;</span>/scope<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
</code></pre></div><ol start="2">
<li>Добавить Spring-ового слушателя в <!-- raw HTML omitted -->web.xml<!-- raw HTML omitted --></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"> <span class="ni">&amp;lt;</span>listener<span class="ni">&amp;gt;</span>
  <span class="ni">&amp;lt;</span>listener-class<span class="ni">&amp;gt;</span>org.jboss.resteasy.plugins.spring.SpringContextLoaderListener<span class="ni">&amp;lt;</span>/listener-class<span class="ni">&amp;gt;</span>
 <span class="ni">&amp;lt;</span>/listener<span class="ni">&amp;gt;</span>

</code></pre></div><p>После этих изменений JBoss RESTEasy будет в курсе про Spring, это позволит в реализации REST-сервисов полноценно использовать все возможности, предоставляемые Spring Framework.</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">({</span><span class="s">&#34;/applicationContext-test.xml&#34;</span><span class="o">})</span>
<span class="nd">@TestExecutionListeners</span><span class="o">({</span><span class="n">DependencyInjectionTestExecutionListener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">DirtiesContextTestExecutionListener</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestEntityServiceRest</span> <span class="o">{</span>

 <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="n">8081</span><span class="o">;</span>
 <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s">&#34;http://localhost:&#34;</span> <span class="o">+</span> <span class="n">PORT</span><span class="o">;</span>

 <span class="nd">@Autowired</span>
 <span class="n">EntityService</span> <span class="n">entityService</span><span class="o">;</span>

 <span class="nd">@Autowired</span>
 <span class="n">ConfigurableApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>


 <span class="kd">protected</span> <span class="n">HttpClient</span> <span class="n">client</span><span class="o">;</span>
 <span class="kd">protected</span> <span class="n">TJWSEmbeddedJaxrsServer</span> <span class="n">server</span><span class="o">;</span>


 <span class="nd">@Before</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUpClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
  <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultHttpClient</span><span class="o">();</span>
 <span class="o">}</span>

 <span class="nd">@Before</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUpServer</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
  <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TJWSEmbeddedJaxrsServer</span><span class="o">();</span>
  <span class="n">server</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="n">PORT</span><span class="o">);</span>
  <span class="n">ResteasyDeployment</span> <span class="n">deployment</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">getDeployment</span><span class="o">();</span>

  <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

  <span class="n">Dispatcher</span> <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">deployment</span><span class="o">.</span><span class="na">getDispatcher</span><span class="o">();</span>
  <span class="n">SpringBeanProcessor</span> <span class="n">processor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringBeanProcessor</span><span class="o">(</span><span class="n">dispatcher</span><span class="o">,</span> <span class="n">deployment</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">(),</span> <span class="n">deployment</span><span class="o">.</span><span class="na">getProviderFactory</span><span class="o">());</span>
  <span class="n">applicationContext</span><span class="o">.</span><span class="na">addBeanFactoryPostProcessor</span><span class="o">(</span><span class="n">processor</span><span class="o">);</span>

  <span class="n">SpringResourceFactory</span> <span class="n">noDefaults</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringResourceFactory</span><span class="o">(</span>
    <span class="s">&#34;entityServiceRestImpl&#34;</span><span class="o">,</span> <span class="n">applicationContext</span><span class="o">,</span> <span class="n">EntityRestServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">dispatcher</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">().</span><span class="na">addResourceFactory</span><span class="o">(</span><span class="n">noDefaults</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="nd">@After</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">server</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
 <span class="o">}</span>

 <span class="nd">@Test</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testListAll</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
  <span class="kd">final</span> <span class="n">List</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">Entity</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">returnedList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">Entity</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;();</span>
  <span class="kt">int</span> <span class="n">EXPECTED_SIZE</span> <span class="o">=</span> <span class="n">6</span><span class="o">;</span>
  <span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">EXPECTED_SIZE</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">i</span><span class="o">++;</span>
   <span class="kd">final</span> <span class="n">Entity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Entity</span><span class="o">();</span>
   <span class="n">entity</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
   <span class="n">entity</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;test&#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
   <span class="n">returnedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">when</span><span class="o">(</span><span class="n">entityService</span><span class="o">.</span><span class="na">findAll</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">returnedList</span><span class="o">);</span>


  <span class="n">HttpGet</span> <span class="n">get</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpGet</span><span class="o">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s">&#34;/service/entity/&#34;</span><span class="o">);</span>

  <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">get</span><span class="o">);</span>
  <span class="n">InputStream</span> <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getEntity</span><span class="o">().</span><span class="na">getContent</span><span class="o">();</span>

  <span class="n">EntityList</span> <span class="n">result</span> <span class="o">=</span> <span class="n">fromString</span><span class="o">(</span><span class="n">EntityList</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">content</span><span class="o">);</span>
  <span class="n">content</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

  <span class="n">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
  <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">EXPECTED_SIZE</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">getEntities</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
 <span class="o">}</span>

 <span class="nd">@Test</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFindById</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

  <span class="kd">final</span> <span class="n">Entity</span> <span class="n">validEntity</span> <span class="o">=</span> <span class="n">getValidEntity</span><span class="o">();</span>
  <span class="n">validEntity</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>

  <span class="n">when</span><span class="o">(</span><span class="n">entityService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">validEntity</span><span class="o">.</span><span class="na">getId</span><span class="o">())).</span><span class="na">thenAnswer</span><span class="o">(</span><span class="k">new</span> <span class="n">Answer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">Object</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;()</span> <span class="o">{</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="n">Object</span> <span class="nf">answer</span><span class="o">(</span><span class="n">InvocationOnMock</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">validEntity</span><span class="o">;</span>
   <span class="o">}</span>
  <span class="o">});</span>

  <span class="n">HttpGet</span> <span class="n">get</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpGet</span><span class="o">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s">&#34;/service/entity/2&#34;</span><span class="o">);</span>

  <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">get</span><span class="o">);</span>
  <span class="n">InputStream</span> <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getEntity</span><span class="o">().</span><span class="na">getContent</span><span class="o">();</span>

  <span class="n">Entity</span> <span class="n">result</span> <span class="o">=</span> <span class="n">fromString</span><span class="o">(</span><span class="n">Entity</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">content</span><span class="o">);</span>
  <span class="n">content</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

  <span class="n">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

  <span class="n">deepAssertEquals</span><span class="o">(</span><span class="n">validEntity</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

 <span class="o">}</span>

 <span class="kd">private</span> <span class="kt">void</span> <span class="nf">deepAssertEquals</span><span class="o">(</span><span class="n">Object</span> <span class="n">expected</span><span class="o">,</span> <span class="n">Object</span> <span class="n">actual</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">InvocationTargetException</span> <span class="o">{</span>
  <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">expected</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">actual</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
  <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">propertyDescriptors</span> <span class="o">=</span> <span class="n">BeanUtils</span><span class="o">.</span><span class="na">getPropertyDescriptors</span><span class="o">(</span><span class="n">expected</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">PropertyDescriptor</span> <span class="n">propertyDescriptor</span> <span class="o">:</span> <span class="n">propertyDescriptors</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">Object</span> <span class="n">expectedValue</span> <span class="o">=</span> <span class="n">propertyDescriptor</span><span class="o">.</span><span class="na">getReadMethod</span><span class="o">().</span><span class="na">invoke</span><span class="o">(</span><span class="n">expected</span><span class="o">);</span>
   <span class="n">Object</span> <span class="n">actualValue</span> <span class="o">=</span> <span class="n">propertyDescriptor</span><span class="o">.</span><span class="na">getReadMethod</span><span class="o">().</span><span class="na">invoke</span><span class="o">(</span><span class="n">actual</span><span class="o">);</span>
   <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">expectedValue</span><span class="o">,</span> <span class="n">actualValue</span><span class="o">);</span>
  <span class="o">}</span>
 <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">T</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">T</span> <span class="nf">fromString</span><span class="o">(</span><span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">T</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">String</span> <span class="n">input</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">JAXBException</span> <span class="o">{</span>
  <span class="n">JAXBContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">JAXBContext</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
  <span class="n">Unmarshaller</span> <span class="n">unmarshaller</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">createUnmarshaller</span><span class="o">();</span>
  <span class="nd">@SuppressWarnings</span><span class="o">(&amp;</span><span class="n">quot</span><span class="o">;</span><span class="n">unchecked</span><span class="o">&amp;</span><span class="n">quot</span><span class="o">;)</span>
  <span class="n">T</span> <span class="n">unmarshal</span> <span class="o">=</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">unmarshaller</span><span class="o">.</span><span class="na">unmarshal</span><span class="o">(</span><span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">input</span><span class="o">));</span>
  <span class="k">return</span> <span class="n">unmarshal</span><span class="o">;</span>
 <span class="o">}</span>

 <span class="kd">public</span> <span class="kd">static</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">T</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">T</span> <span class="nf">fromString</span><span class="o">(</span><span class="n">Class</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">T</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">InputStream</span> <span class="n">input</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">JAXBException</span> <span class="o">{</span>
  <span class="n">JAXBContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">JAXBContext</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
  <span class="nd">@SuppressWarnings</span><span class="o">(&amp;</span><span class="n">quot</span><span class="o">;</span><span class="n">unchecked</span><span class="o">&amp;</span><span class="n">quot</span><span class="o">;)</span>
  <span class="n">T</span> <span class="n">unmarshal</span> <span class="o">=</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">createUnmarshaller</span><span class="o">().</span><span class="na">unmarshal</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">unmarshal</span><span class="o">;</span>
 <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><!-- raw HTML omitted -->
<p>Для этого нам необходимо внести следующие модификации в <!-- raw HTML omitted -->pom.xml<!-- raw HTML omitted -->:</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml">
<span class="ni">&amp;lt;</span>plugin<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.apache.maven.plugins<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>maven-surefire-plugin<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>version<span class="ni">&amp;gt;</span>2.11<span class="ni">&amp;lt;</span>/version<span class="ni">&amp;gt;</span>

    <span class="ni">&amp;lt;</span>executions<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>execution<span class="ni">&amp;gt;</span>
     <span class="ni">&amp;lt;</span>id<span class="ni">&amp;gt;</span>Unit tests<span class="ni">&amp;lt;</span>/id<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>phase<span class="ni">&amp;gt;</span>test<span class="ni">&amp;lt;</span>/phase<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>goals<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>goal<span class="ni">&amp;gt;</span>test<span class="ni">&amp;lt;</span>/goal<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>/goals<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>configuration<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>excludes<span class="ni">&amp;gt;</span>
                    <span class="ni">&amp;lt;</span>exclude<span class="ni">&amp;gt;</span>**/IT*.java<span class="ni">&amp;lt;</span>/exclude<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>/excludes<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>/configuration<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>/execution<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>execution<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>id<span class="ni">&amp;gt;</span>Integration tests<span class="ni">&amp;lt;</span>/id<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>phase<span class="ni">&amp;gt;</span>integration-test<span class="ni">&amp;lt;</span>/phase<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>goals<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>goal<span class="ni">&amp;gt;</span>test<span class="ni">&amp;lt;</span>/goal<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>/goals<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>configuration<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>includes<span class="ni">&amp;gt;</span>
                    <span class="ni">&amp;lt;</span>include<span class="ni">&amp;gt;</span>**/IT*.java<span class="ni">&amp;lt;</span>/include<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>/includes<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>/configuration<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>/execution<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>/executions<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/plugin<span class="ni">&amp;gt;</span>

<span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.apache.httpcomponents<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>httpclient<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>version<span class="ni">&amp;gt;</span>4.1.2<span class="ni">&amp;lt;</span>/version<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>scope<span class="ni">&amp;gt;</span>test<span class="ni">&amp;lt;</span>/scope<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.jboss.resteasy<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>resteasy-jaxrs<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>scope<span class="ni">&amp;gt;</span>test<span class="ni">&amp;lt;</span>/scope<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.jboss.resteasy<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>resteasy-spring<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>scope<span class="ni">&amp;gt;</span>test<span class="ni">&amp;lt;</span>/scope<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.jboss.resteasy<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>tjws<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>version<span class="ni">&amp;gt;</span>${resteasy-jaxrs.version}<span class="ni">&amp;lt;</span>/version<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>javax.servlet<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>servlet-api<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>scope<span class="ni">&amp;gt;</span>test<span class="ni">&amp;lt;</span>/scope<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>dependency<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>commons-io<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>commons-io<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>scope<span class="ni">&amp;gt;</span>test<span class="ni">&amp;lt;</span>/scope<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dependency<span class="ni">&amp;gt;</span>
</code></pre></div><!-- raw HTML omitted -->

        

    </article>
    
    <article>

        
        

<header>
    <h1 class="entry-title">
        <a href="https://uthark.github.io/2012/01/28/aspectj/">Немножко магии от AspectJ</a>
    </h1>

</header>


        
        <p>Наверно, вы уже сталкивались с таким понятием, как AOП - <!-- raw HTML omitted -->аспектно-ориентированное программирование<!-- raw HTML omitted -->.</p>
<p>Обычно, про него вспоминают, когда говорят про <!-- raw HTML omitted -->декларативное использование транзакций<!-- raw HTML omitted -->,  про <!-- raw HTML omitted -->проверку прав доступа<!-- raw HTML omitted -->, либо про <!-- raw HTML omitted -->реализацию журналирования<!-- raw HTML omitted -->.</p>
<p>Но это не единственные области применения АОП.</p>
<p>Я хочу показать ещё пару областей применения из реальных проектов:</p>
<ul>
<li>Модификация исходного кода для реализации дополнительных возможностей.</li>
<li>Принудительная проверка контракта между модулями.</li>
</ul>
<h4 id="модификация-исходного-кода-для-реализации-дополнительных-возможностей">Модификация исходного кода для реализации дополнительных возможностей</h4>
<p>Предположим, что у нас есть модуль в приложении, который предоставляет нужную нам функциональность. С модулем всё в порядке, кроме одного - все его методы могут выбрасывать проверяемые исключения, что ведёт к ухудшению читаемости кода, так как вместо простого вызова метода:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">service</span><span class="o">.</span><span class="na">doUsefulThing</span><span class="o">();</span>
</code></pre></div><p>наш вызов превращается в следующую конструкцию</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="k">try</span> <span class="o">{</span>
    <span class="n">service</span><span class="o">.</span><span class="na">doUsefulThing</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span> <span class="n">FirstServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">processException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span> <span class="n">SecondServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">processException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></div><p>Дополнительная проблема в том, что у модуля количество модулей 10+, количество методов также велико, что приводит к тому, что блоки <code>try/catch</code> замусоривают код. Решение с использованием паттерна <!-- raw HTML omitted --><code>Callback</code><!-- raw HTML omitted --> также приведёт к замусориванию кода.</p>
<h4 id="вариант-решения-проблемы-с-использованием-aop">Вариант решения проблемы с использованием AOP</h4>
<p>Решение данной проблемы было таким - а что, если используя возможности AOP трансформировать проверяемое исключение в непроверяемое? Таким образом, мы сможем избавиться от скучной проверки на исключения в нашем коде, а для обработки исключения (ведь мы всегда его будем обрабатывать одинаково) достаточно будет использовать обработку исключения на верхнем уровне абстракции.</p>
<p>Для более элегантного решения проблемы было решено добавить собственную аннотацию, которой нужно помечать метод, который использует сервис из «плохого» модуля.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.blogger.atamanenko</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Inherited</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>

<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="nd">@Documented</span>
<span class="nd">@Inherited</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">SuppressExceptions</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div><p>А также аспект, который бы делал всю нужную нам функциональность:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">aspect</span> <span class="n">ExceptionSupressingAspect</span> <span class="o">{</span>

        <span class="n">declare</span> <span class="n">soft</span> <span class="o">:</span><span class="n">ServiceException</span><span class="o">:</span>  <span class="n">execution</span><span class="o">(</span><span class="nd">@com.blogger.atamanenko.annotation.SuppressExceptions</span> <span class="o">*</span> <span class="o">*.*(..));</span>
<span class="o">}</span>
</code></pre></div><p>Данный аспект делает в точности следующее: &ldquo;Смягчает&rdquo; исключение <code>ServiceException</code> для метода, который помечен аннотацией <code>@SuppressExceptions</code>.</p>
<p>Пример использования:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="nd">@SuppressExceptions</span>
    <span class="kd">protected</span> <span class="n">Entity</span> <span class="nf">findEntity</span><span class="o">(</span><span class="kd">final</span> <span class="n">Identifiable</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entityService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div><h4 id="принудительная-проверка-контракта-между-модулями">Принудительная проверка контракта между модулями</h4>
<p>Часто нам необходимо принудительно требовать выполнения каких-то архитектурных ограничений, например, контроллеры должны работать только с сервисами и им запрещено напрямую обращаться к базе данных.</p>
<p>Для реализации таких проверок можно также использовать возможности AOP.</p>
<p>Предположим, что в нашем приложении модуль сервиса выставляет наружу <!-- raw HTML omitted -->DTO<!-- raw HTML omitted --> для работы, скрывая при этом классы модели. Для того, чтобы явно запретить доступ к классам и методам модели нам необходимо создать аспект, который бы вызывал ошибку компиляции при нарушении ограничения.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">aspect</span> <span class="n">ForbidAccessToModelAspect</span> <span class="o">{</span>

<span class="c1">//      Full prohibition of access to model:
</span><span class="c1"></span>        <span class="n">pointcut</span> <span class="nf">accessModel</span><span class="o">():</span> <span class="n">call</span><span class="o">(*</span> <span class="n">com</span><span class="o">.</span><span class="na">blogger</span><span class="o">.</span><span class="na">atamanenko</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">model</span><span class="o">..*.*(..));</span>
        <span class="n">declare</span> <span class="n">error</span><span class="o">:</span> <span class="n">accessModel</span><span class="o">()</span> <span class="o">:</span> <span class="s">&#34;Illegal call to model&#34;</span><span class="o">;</span>
<span class="o">}</span>

</code></pre></div><p>После объявления такого аспекта, мы получим ошибку компиляции, что, очевидным образом, приведёт к выполнению архитектурного ограничения.</p>
<p>Если же нам необходимо разрешить доступ к одному пакету только из какого-то определённого другого, то мы можем модифицировать наш аспект следующим образом:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">aspect</span> <span class="n">ForbidAccessToModelAspect2</span> <span class="o">{</span>

        <span class="n">pointcut</span> <span class="nf">accessModel</span><span class="o">():</span> <span class="n">call</span><span class="o">(*</span> <span class="n">com</span><span class="o">.</span><span class="na">blogger</span><span class="o">.</span><span class="na">atamanenko</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">model</span><span class="o">.**.*(..));</span>

        <span class="c1">// Allow access to model from specific package for methods and constructors
</span><span class="c1"></span>        <span class="n">pointcut</span> <span class="nf">allowAccessModelFromSpecificPackage</span><span class="o">():</span> <span class="n">withincode</span><span class="o">(*</span> <span class="n">com</span><span class="o">.</span><span class="na">blogger</span><span class="o">.</span><span class="na">atamanenko</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">allowedpackage</span><span class="o">..*.*(..));</span>
        <span class="n">pointcut</span> <span class="nf">allowAccessModelFromSpecificPackage2</span><span class="o">():</span> <span class="n">withincode</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">blogger</span><span class="o">.</span><span class="na">atamanenko</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">allowedpackage</span><span class="o">..*.</span><span class="na">new</span><span class="o">(..));</span>

        <span class="c1">// forbid usage from any other methods.
</span><span class="c1"></span>        <span class="n">declare</span> <span class="n">error</span><span class="o">:</span> <span class="n">accessModel</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!(</span><span class="n">allowAccessModelFromSpecificPackage</span><span class="o">()</span> <span class="o">||</span> <span class="n">allowAccessModelFromSpecificPackage</span><span class="o">()):</span><span class="s">&#34;Illegal call to Model from forbidden package&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>Такой аспект, созданный в нашем модуле запретит нам использовать классы модели из всех пакетов, кроме <code>com.blogger.atamanenko.app.allowedpackage</code></p>
<h4 id="сборка-приложения">Сборка приложения</h4>
<p>Файл аспекта нужно положить в каталог <code>src/main/aspect</code>, а для сборки приложения необходимо использовать не стандартный Oracle <!-- raw HTML omitted -->Java Compiler<!-- raw HTML omitted -->, а <!-- raw HTML omitted -->AspectJ compiler<!-- raw HTML omitted -->.</p>
<p>Пример конфигурации для <!-- raw HTML omitted -->Apache Maven<!-- raw HTML omitted -->:</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ni">&amp;lt;</span>plugin<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.codehaus.mojo<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>aspectj-maven-plugin<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>version<span class="ni">&amp;gt;</span>${aspectj-maven-plugin.version}<span class="ni">&amp;lt;</span>/version<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>configuration<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>complianceLevel<span class="ni">&amp;gt;</span>1.6<span class="ni">&amp;lt;</span>/complianceLevel<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>aspectLibraries<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>aspectLibrary<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>groupId<span class="ni">&amp;gt;</span>org.springframework<span class="ni">&amp;lt;</span>/groupId<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>artifactId<span class="ni">&amp;gt;</span>spring-aspects<span class="ni">&amp;lt;</span>/artifactId<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>/aspectLibrary<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>/aspectLibraries<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>verbose<span class="ni">&amp;gt;</span>true<span class="ni">&amp;lt;</span>/verbose<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>/configuration<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>executions<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>execution<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>phase<span class="ni">&amp;gt;</span>process-sources<span class="ni">&amp;lt;</span>/phase<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>goals<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>goal<span class="ni">&amp;gt;</span>compile<span class="ni">&amp;lt;</span>/goal<span class="ni">&amp;gt;</span>
                <span class="ni">&amp;lt;</span>goal<span class="ni">&amp;gt;</span>test-compile<span class="ni">&amp;lt;</span>/goal<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>/goals<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>/execution<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>/executions<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/plugin<span class="ni">&amp;gt;</span>
</code></pre></div><h4 id="заключение">Заключение</h4>
<p>Вот в общем-то и всё. Я сознательно не стал описывать языковые конструкции аспектов, так как они подробно описаны в <!-- raw HTML omitted -->руководстве AspectJ<!-- raw HTML omitted --></p>

        

    </article>
    
    <article>

        
        

<header>
    <h1 class="entry-title">
        <a href="https://uthark.github.io/2011/07/21/java/">Немного о виртуальных методах в Java</a>
    </h1>

</header>


        
        <p>Сегодня я хочу рассмотреть некоторые особенности переопределения методов в Java.  В java нельзя переопределить:   <!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
     <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
     <span class="kt">int</span> <span class="nf">getI</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="n">i</span><span class="o">;}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">B</span> <span class="kd">extends</span> <span class="n">A</span><span class="o">{</span>
     <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">5</span><span class="o">;</span>
     <span class="kt">int</span> <span class="nf">getI</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="n">i</span><span class="o">;}</span>
<span class="o">}</span>

<span class="n">A</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">B</span><span class="o">();</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">i</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getI</span><span class="o">());</span>

</code></pre></div><p>Вопрос: что выведет данный код?<!-- raw HTML omitted -->
Ответ: <!-- raw HTML omitted --></p>
<ol>
<li>Так как поля класса не наследуются, то у класса A своё поле i и у класса B тоже своё поле i. Так как для полей полиморфизм не действует, то при обращении a.i мы обращаемся к классу A, поэтому на экран будет выведено 3.<!-- raw HTML omitted --></li>
<li>При вызове метода a.getI() у нас в дело вступает полиморфизм, поэтому будет вызван метод от класса, инстанс которого был создан. Соответственно, мы получим на выходе 5.<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
Другой пример:<!-- raw HTML omitted -->
<!-- raw HTML omitted --></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
     <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
     <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getI</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="n">i</span><span class="o">;}</span> 
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">B</span> <span class="kd">extends</span> <span class="n">A</span><span class="o">{</span>
     <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">5</span><span class="o">;</span>
     <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getI</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="n">i</span><span class="o">;}</span>
<span class="o">}</span>

<span class="n">A</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">B</span><span class="o">();</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">i</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getI</span><span class="o">());</span>

</code></pre></div><p>Статические поля и методы виртуальными не являются, поэтому оба вызова выведут нам 3.</p>

        

    </article>
    
    
    




<div class="pagination">

    
        
        
        
        <a href="/" aria-label="First" class="label-pagination"><i class="fa fa-angle-double-left fa-lg"></i></a>
    

    
    
        <a href="/page/5/" aria-label="Previous" class="label-pagination"><i class="fa fa-angle-left fa-lg"></i></a>
    

    
        <a href="/" class="label-pagination">1</a>
    
        <a href="/page/2/" class="label-pagination">2</a>
    
        <a href="/page/3/" class="label-pagination">3</a>
    
        <a href="/page/4/" class="label-pagination">4</a>
    
        <a href="/page/5/" class="label-pagination">5</a>
    
        <a href="/page/6/" class="label-pagination">6</a>
    
        <a href="/page/7/" class="label-pagination">7</a>
    
        <a href="/page/8/" class="label-pagination">8</a>
    
        <a href="/page/9/" class="label-pagination">9</a>
    
        <a href="/page/10/" class="label-pagination">10</a>
    
        <a href="/page/11/" class="label-pagination">11</a>
    

    
    
        <a href="/page/7/" aria-label="Next" class="label-pagination"><i class="fa fa-angle-right fa-lg"></i></a>
    

    
    
        <a href="/page/11/" aria-label="Last"><i class="fa fa-angle-double-right fa-lg"></i></a>
    

</div>

  

  </div>

  

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>






  

  

  
  
  

</aside>
    
 </div>
</div>

<footer>
    
    <div class="center">
        <ul class="sidebar-nav">
            <li class="sidebar-nav-item">
                <a target="_blank" href="https://github.com/uthark/" title="https://github.com/uthark/"><i
                    class="fa fa-github fa-2x"></i></a></li>
            <li class="sidebar-nav-item">    <a target="_blank" href="https://bitbucket.org/uthark/" title="https://bitbucket.org/uthark/"><i
                    class="fa fa-bitbucket fa-2x"></i></a>
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item"><a target="_blank" href="https://twitter.com/real_atamanenko" title="https://twitter.com/real_atamanenko"><i
                    class="fa fa-twitter fa-2x"></i></a>
            <li class="sidebar-nav-item"><a target="_blank" href="https://keybase.io/uthark/" title="https://keybase.io/uthark/"><i
                    class="fa fa-key fa-2x"></i></a> 
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item"><a target="_blank" href="http://stackoverflow.com/users/216764/uthark" title="http://stackoverflow.com/users/216764/uthark"><i
                    class="fa fa-stack-overflow fa-2x"></i></a>
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
            <li class="sidebar-nav-item">
                
                
            </li>
            
                
                    
                    
                        <li><a href="https://feeds.feedburner.com/atamanenko" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-2x"></i></a></li>
                    

                
            
        </ul>
    </div>
    <p>&copy;&nbsp;2009&nbsp;—&nbsp;2020 Oleg Atamanenko - <a href="https://uthark.github.io/license/">CC&nbsp;BY-SA&nbsp;4.0</a>
    </p>

</footer>


<script>
    var _gaq = [['_setAccount', 'UA-8688665-1'], ['_trackPageview']];
    (function (d, t) {
        var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
        s.async = 'async'
        g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g, s)
    }(document, 'script'));
</script>


</body>
</html>
   
