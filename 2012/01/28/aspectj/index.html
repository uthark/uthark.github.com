<!doctype html><html>
<head>
<meta charset=utf-8>
<title>
Немножко магии от AspectJ &ndash; Oleg Atamanenko
</title>
<link rel=stylesheet media=screen href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300&family=Prata&display=swap" type=text/css>
<link rel=stylesheet href=https://uthark.github.io/css/theme.6e6c1b2c79e89e36c8ab0a167a615efa6b0320017c80244b0c72043ea3ac4bcf.css>
<link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css>
<link href=https://uthark.github.io/favicon.png rel=icon>
</head>
<body>
<header class=site>
<h1><a href=https://uthark.github.io/>Oleg Atamanenko</a></h1>
<h2>thoughts about programming</h2>
</header>
<nav>
<ul class=main-navigation>
<li><a href=https://uthark.github.io/ title=Posts>Posts</a></li>
<li><a href=https://uthark.github.io/categories/ title=Categories>Categories</a></li>
<li><a href=https://uthark.github.io/usefularticles/ title=Links>Links</a></li>
<li><a href=https://uthark.github.io/about/ title="About me">About me</a></li>
</ul>
</nav>
<div class=article>
<h1>Немножко магии от AspectJ</h1>
<p>Наверно, вы уже сталкивались с таким понятием, как AOП - <a href=http://en.wikipedia.org/wiki/Aspect-oriented_programming>аспектно-ориентированное программирование</a>.</p>
<p>Обычно, про него вспоминают, когда говорят про <a href=http://static.springsource.org/spring/docs/current/reference/html/transaction.html#transaction-declarative-applying-more-than-just-tx-advice>декларативное использование транзакций</a>, про <a href=https://docs.jboss.com/aop/1.0/aspect-library/reference/annotation15_security.html>проверку прав доступа</a>, либо про <a href=http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/aop/interceptor/CustomizableTraceInterceptor.html>реализацию журналирования</a>.</p>
<p>Но это не единственные области применения АОП.</p>
<p>Я хочу показать ещё пару областей применения из реальных проектов:</p>
<ul>
<li>Модификация исходного кода для реализации дополнительных возможностей.</li>
<li>Принудительная проверка контракта между модулями.</li>
</ul>
<h4 id=модификация-исходного-кода-для-реализации-дополнительных-возможностей>Модификация исходного кода для реализации дополнительных возможностей</h4>
<p>Предположим, что у нас есть модуль в приложении, который предоставляет нужную нам функциональность. С модулем всё в порядке, кроме одного - все его методы могут выбрасывать проверяемые исключения, что ведёт к ухудшению читаемости кода, так как вместо простого вызова метода:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>service</span><span class=o>.</span><span class=na>doUsefulThing</span><span class=o>();</span>
</code></pre></div><p>наш вызов превращается в следующую конструкцию</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=k>try</span> <span class=o>{</span>
    <span class=n>service</span><span class=o>.</span><span class=na>doUsefulThing</span><span class=o>();</span>
<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span> <span class=n>FirstServiceException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>processException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span> <span class=n>SecondServiceException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>processException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
<span class=o>}</span>

</code></pre></div><p>Дополнительная проблема в том, что у модуля количество модулей 10+, количество методов также велико, что приводит к тому, что блоки <code>try/catch</code> замусоривают код. Решение с использованием паттерна <a href=https://en.wikipedia.org/wiki/Callback_(computer_programming)><code>Callback</code></a> также приведёт к замусориванию кода.</p>
<h4 id=вариант-решения-проблемы-с-использованием-aop>Вариант решения проблемы с использованием AOP</h4>
<p>Решение данной проблемы было таким - а что, если используя возможности AOP трансформировать проверяемое исключение в непроверяемое? Таким образом, мы сможем избавиться от скучной проверки на исключения в нашем коде, а для обработки исключения (ведь мы всегда его будем обрабатывать одинаково) достаточно будет использовать обработку исключения на верхнем уровне абстракции.</p>
<p>Для более элегантного решения проблемы было решено добавить собственную аннотацию, которой нужно помечать метод, который использует сервис из «плохого» модуля.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>com.blogger.atamanenko</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>java.lang.annotation.Documented</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.lang.annotation.Inherited</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.lang.annotation.Retention</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.lang.annotation.Target</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.lang.annotation.RetentionPolicy</span><span class=o>;</span>

<span class=nd>@Retention</span><span class=o>(</span><span class=n>RetentionPolicy</span><span class=o>.</span><span class=na>RUNTIME</span><span class=o>)</span>
<span class=nd>@Target</span><span class=o>({</span><span class=n>ElementType</span><span class=o>.</span><span class=na>METHOD</span><span class=o>})</span>
<span class=nd>@Documented</span>
<span class=nd>@Inherited</span>
<span class=kd>public</span> <span class=nd>@interface</span> <span class=n>SuppressExceptions</span> <span class=o>{</span>
<span class=o>}</span>
</code></pre></div><p>А также аспект, который бы делал всю нужную нам функциональность:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>aspect</span> <span class=n>ExceptionSupressingAspect</span> <span class=o>{</span>

        <span class=n>declare</span> <span class=n>soft</span> <span class=o>:</span><span class=n>ServiceException</span><span class=o>:</span>  <span class=n>execution</span><span class=o>(</span><span class=nd>@com.blogger.atamanenko.annotation.SuppressExceptions</span> <span class=o>*</span> <span class=o>*.*(..));</span>
<span class=o>}</span>
</code></pre></div><p>Данный аспект делает в точности следующее: &ldquo;Смягчает&rdquo; исключение <code>ServiceException</code> для метода, который помечен аннотацией <code>@SuppressExceptions</code>.</p>
<p>Пример использования:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java>    <span class=nd>@SuppressExceptions</span>
    <span class=kd>protected</span> <span class=n>Entity</span> <span class=nf>findEntity</span><span class=o>(</span><span class=kd>final</span> <span class=n>Identifiable</span> <span class=n>id</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>entityService</span><span class=o>.</span><span class=na>findById</span><span class=o>(</span><span class=n>id</span><span class=o>);</span>
    <span class=o>}</span>
</code></pre></div><h4 id=принудительная-проверка-контракта-между-модулями>Принудительная проверка контракта между модулями</h4>
<p>Часто нам необходимо принудительно требовать выполнения каких-то архитектурных ограничений, например, контроллеры должны работать только с сервисами и им запрещено напрямую обращаться к базе данных.</p>
<p>Для реализации таких проверок можно также использовать возможности AOP.</p>
<p>Предположим, что в нашем приложении модуль сервиса выставляет наружу <a href=http://java.sun.com/blueprints/corej2eepatterns/Patterns/TransferObject.html>DTO</a> для работы, скрывая при этом классы модели. Для того, чтобы явно запретить доступ к классам и методам модели нам необходимо создать аспект, который бы вызывал ошибку компиляции при нарушении ограничения.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>aspect</span> <span class=n>ForbidAccessToModelAspect</span> <span class=o>{</span>

<span class=c1>//      Full prohibition of access to model:
</span><span class=c1></span>        <span class=n>pointcut</span> <span class=nf>accessModel</span><span class=o>():</span> <span class=n>call</span><span class=o>(*</span> <span class=n>com</span><span class=o>.</span><span class=na>blogger</span><span class=o>.</span><span class=na>atamanenko</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>model</span><span class=o>..*.*(..));</span>
        <span class=n>declare</span> <span class=n>error</span><span class=o>:</span> <span class=n>accessModel</span><span class=o>()</span> <span class=o>:</span> <span class=s>&#34;Illegal call to model&#34;</span><span class=o>;</span>
<span class=o>}</span>

</code></pre></div><p>После объявления такого аспекта, мы получим ошибку компиляции, что, очевидным образом, приведёт к выполнению архитектурного ограничения.</p>
<p>Если же нам необходимо разрешить доступ к одному пакету только из какого-то определённого другого, то мы можем модифицировать наш аспект следующим образом:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>aspect</span> <span class=n>ForbidAccessToModelAspect2</span> <span class=o>{</span>

        <span class=n>pointcut</span> <span class=nf>accessModel</span><span class=o>():</span> <span class=n>call</span><span class=o>(*</span> <span class=n>com</span><span class=o>.</span><span class=na>blogger</span><span class=o>.</span><span class=na>atamanenko</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>model</span><span class=o>.**.*(..));</span>

        <span class=c1>// Allow access to model from specific package for methods and constructors
</span><span class=c1></span>        <span class=n>pointcut</span> <span class=nf>allowAccessModelFromSpecificPackage</span><span class=o>():</span> <span class=n>withincode</span><span class=o>(*</span> <span class=n>com</span><span class=o>.</span><span class=na>blogger</span><span class=o>.</span><span class=na>atamanenko</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>allowedpackage</span><span class=o>..*.*(..));</span>
        <span class=n>pointcut</span> <span class=nf>allowAccessModelFromSpecificPackage2</span><span class=o>():</span> <span class=n>withincode</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>blogger</span><span class=o>.</span><span class=na>atamanenko</span><span class=o>.</span><span class=na>app</span><span class=o>.</span><span class=na>allowedpackage</span><span class=o>..*.</span><span class=na>new</span><span class=o>(..));</span>

        <span class=c1>// forbid usage from any other methods.
</span><span class=c1></span>        <span class=n>declare</span> <span class=n>error</span><span class=o>:</span> <span class=n>accessModel</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!(</span><span class=n>allowAccessModelFromSpecificPackage</span><span class=o>()</span> <span class=o>||</span> <span class=n>allowAccessModelFromSpecificPackage</span><span class=o>()):</span><span class=s>&#34;Illegal call to Model from forbidden package&#34;</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></div><p>Такой аспект, созданный в нашем модуле запретит нам использовать классы модели из всех пакетов, кроме <code>com.blogger.atamanenko.app.allowedpackage</code></p>
<h4 id=сборка-приложения>Сборка приложения</h4>
<p>Файл аспекта нужно положить в каталог <code>src/main/aspect</code>, а для сборки приложения необходимо использовать не стандартный Oracle <a href=http://docs.oracle.com/javase/6/docs/technotes/tools/solaris/javac.html>Java Compiler</a>, а <a href=http://eclipse.org/aspectj/downloads.php>AspectJ compiler</a>.</p>
<p>Пример конфигурации для <a href=https://maven.apache.org/>Apache Maven</a>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=ni>&amp;lt;</span>plugin<span class=ni>&amp;gt;</span>
    <span class=ni>&amp;lt;</span>groupId<span class=ni>&amp;gt;</span>org.codehaus.mojo<span class=ni>&amp;lt;</span>/groupId<span class=ni>&amp;gt;</span>
    <span class=ni>&amp;lt;</span>artifactId<span class=ni>&amp;gt;</span>aspectj-maven-plugin<span class=ni>&amp;lt;</span>/artifactId<span class=ni>&amp;gt;</span>
    <span class=ni>&amp;lt;</span>version<span class=ni>&amp;gt;</span>${aspectj-maven-plugin.version}<span class=ni>&amp;lt;</span>/version<span class=ni>&amp;gt;</span>
    <span class=ni>&amp;lt;</span>configuration<span class=ni>&amp;gt;</span>
        <span class=ni>&amp;lt;</span>complianceLevel<span class=ni>&amp;gt;</span>1.6<span class=ni>&amp;lt;</span>/complianceLevel<span class=ni>&amp;gt;</span>
        <span class=ni>&amp;lt;</span>aspectLibraries<span class=ni>&amp;gt;</span>
            <span class=ni>&amp;lt;</span>aspectLibrary<span class=ni>&amp;gt;</span>
                <span class=ni>&amp;lt;</span>groupId<span class=ni>&amp;gt;</span>org.springframework<span class=ni>&amp;lt;</span>/groupId<span class=ni>&amp;gt;</span>
                <span class=ni>&amp;lt;</span>artifactId<span class=ni>&amp;gt;</span>spring-aspects<span class=ni>&amp;lt;</span>/artifactId<span class=ni>&amp;gt;</span>
            <span class=ni>&amp;lt;</span>/aspectLibrary<span class=ni>&amp;gt;</span>
        <span class=ni>&amp;lt;</span>/aspectLibraries<span class=ni>&amp;gt;</span>
        <span class=ni>&amp;lt;</span>verbose<span class=ni>&amp;gt;</span>true<span class=ni>&amp;lt;</span>/verbose<span class=ni>&amp;gt;</span>
    <span class=ni>&amp;lt;</span>/configuration<span class=ni>&amp;gt;</span>
    <span class=ni>&amp;lt;</span>executions<span class=ni>&amp;gt;</span>
        <span class=ni>&amp;lt;</span>execution<span class=ni>&amp;gt;</span>
            <span class=ni>&amp;lt;</span>phase<span class=ni>&amp;gt;</span>process-sources<span class=ni>&amp;lt;</span>/phase<span class=ni>&amp;gt;</span>
            <span class=ni>&amp;lt;</span>goals<span class=ni>&amp;gt;</span>
                <span class=ni>&amp;lt;</span>goal<span class=ni>&amp;gt;</span>compile<span class=ni>&amp;lt;</span>/goal<span class=ni>&amp;gt;</span>
                <span class=ni>&amp;lt;</span>goal<span class=ni>&amp;gt;</span>test-compile<span class=ni>&amp;lt;</span>/goal<span class=ni>&amp;gt;</span>
            <span class=ni>&amp;lt;</span>/goals<span class=ni>&amp;gt;</span>
        <span class=ni>&amp;lt;</span>/execution<span class=ni>&amp;gt;</span>
    <span class=ni>&amp;lt;</span>/executions<span class=ni>&amp;gt;</span>
<span class=ni>&amp;lt;</span>/plugin<span class=ni>&amp;gt;</span>
</code></pre></div><h4 id=заключение>Заключение</h4>
<p>Вот в общем-то и всё. Я сознательно не стал описывать языковые конструкции аспектов, так как они подробно описаны в <a href=https://www.eclipse.org/aspectj/doc/next/progguide/index.html>руководстве AspectJ</a></p>
</div>
<footer>
<div class=social>
<ul>
<li class=sidebar-nav-item><a target=_blank href=https://github.com/uthark/ title=https://github.com/uthark/><i class="fa fa-github fa-2x"></i></a>
</li>
<li class=sidebar-nav-item> <a target=_blank href=https://bitbucket.org/uthark/ title=https://bitbucket.org/uthark/><i class="fa fa-bitbucket fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://twitter.com/real_atamanenko title=https://twitter.com/real_atamanenko><i class="fa fa-twitter fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://keybase.io/uthark/ title=https://keybase.io/uthark/><i class="fa fa-key fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=http://stackoverflow.com/users/216764/uthark title=http://stackoverflow.com/users/216764/uthark><i class="fa fa-stack-overflow fa-2x"></i></a>
</li>
<li><a href=https://feeds.feedburner.com/atamanenko target=_blank type=application/rss+xml title=RSS><i class="fa fa-rss-square fa-2x"></i></a></li>
</ul>
</div>
<p>&copy;&nbsp;2009&nbsp;—&nbsp;2021 Oleg Atamanenko - <a href=https://uthark.github.io/license/>CC&nbsp;BY-SA&nbsp;4.0</a>
</p>
</footer>
<script>var _gaq=[['_setAccount','UA-8688665-1'],['_trackPageview']];(function(b,c){var d=b.createElement(c),a=b.getElementsByTagName(c)[0];a.async='async',d.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js',a.parentNode.insertBefore(d,a)})(document,'script')</script>
</body>
</html>
</body>
</html>