<!doctype html><html><head><meta charset=utf-8><title>Ищем с помощью Spring Data JPA &ndash; Oleg Atamanenko</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=theme-color content="#333" media="(prefers-color-scheme: dark)"><meta name=theme-color content="#777" media="(prefers-color-scheme: light)"><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link rel=stylesheet media=screen href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300&family=Prata&display=swap" type=text/css><link rel=stylesheet href=https://uthark.github.io/css/theme.72254bdf9ec9fc2d8b013dd5c21997b2ab476af1a37ded5995aae71c4a63d57d.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css><link href=https://uthark.github.io/favicon.png rel=icon></head><body><header class=site><h1><a href=https://uthark.github.io/>Oleg Atamanenko</a></h1><h2>thoughts about programming</h2></header><nav><ul class=main-navigation><li><a href=https://uthark.github.io/ title=Posts>Posts</a></li><li><a href=https://uthark.github.io/categories/ title=Categories>Categories</a></li><li><a href=https://uthark.github.io/usefularticles/ title=Links>Links</a></li><li><a href=https://uthark.github.io/about/ title="About me">About me</a></li></ul></nav><div class=article><h1>Ищем с помощью Spring Data JPA</h1><p>Рассмотрим подробнее одну из наиболее полезных вещей в Spring Data JPA - генерация JPQL-запросов на основе имени метода.</p><p>Spring Data JPA умеет автоматически генерировать запросы используя для подсказки название метода.</p><p>Например, метод <code>User.findByLoginAndPassword</code> сгенерирует примерно следующий код:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=k>User</span><span class=w> </span><span class=n>u</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>u</span><span class=p>.</span><span class=n>login</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>login</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>password</span><span class=w>
</span></span></span></code></pre></div><p>Вообще Spring Data JPA пытается быть умным, поэтому реализация <tt>findBy{&mldr;}</tt> методов ищется следующим образом:</p><ol><li>Сначала смотрится аннотация <a href=http://static.springsource.org/spring-data/data-jpa/docs/current/api/org/springframework/data/jpa/repository/Query.html>@Query</a> на объявлении метода, если она есть, то используется.</li><li>Затем смотрится аннотация <a href=http://docs.oracle.com/javaee/5/api/javax/persistence/NamedQuery.html>@NamedQuery</a> с именем вида <tt>Entity.findMethodName</tt>, для вышеприведённого случая это будет <tt>User.findByLoginAndPassword</tt>.</li><li>Если ничего не нашли. то по сигнатуре метода <a href=https://github.com/SpringSource/spring-data-jpa/blob/master/src/main/java/org/springframework/data/jpa/repository/query/JpaQueryCreator.java>генерируется запрос</a>.</li></ol><p>У <tt>@Query</tt> следующие плюсы:</p><ol><li>Позволяет не засорять объявление доменной сущности.</li><li>Сильно помогает, если у нас в запросе есть неявные джойны, потому что для таких запросов Spring Data JPA <a href=https://jira.springsource.org/browse/DATAJPA-35>не умеет корректно генерировать</a> запрос <tt>SELECT COUNT(*)</tt>, который нужен в тех случаях, когда метод должен вернуть <a href=http://static.springsource.org/spring-data/data-commons/docs/current/api/org/springframework/data/domain/Page.html>Page</a>.</li></ol><p>Очевидно, что при использовании запросов нам необходимо каким-то образом указывать параметры для запросов. Для этого есть аннотация <a href=http://static.springsource.org/spring-data/data-commons/docs/current/api/org/springframework/data/repository/query/Param.html>@Param</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Query</span><span class=o>(</span><span class=s>&#34;select u from User u where u.login = :login and u.password = :password&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=n>Page</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>findByLoginAndPassword</span><span class=o>(</span><span class=nd>@Param</span><span class=o>(</span><span class=s>&#34;login&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>login</span><span class=o>,</span> <span class=nd>@Param</span><span class=o>(</span><span class=s>&#34;password&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>password</span><span class=o>);</span>
</span></span></code></pre></div><p>Кроме того, Spring Data JPA поддерживает отличную <a href=http://www.martinfowler.com/apsupp/spec.pdf>концепцию спецификаций</a>.</p><p>Спецификации позволяют делать составлять сложные запросы из набора простых.</p><p>Для поддержки спецификаций необходимо объявить метод в репозитории:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Page</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>findAll</span><span class=o>(</span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>spec</span><span class=o>,</span> <span class=n>Pageable</span> <span class=n>pageable</span><span class=o>);</span>
</span></span></code></pre></div><p>Спецификация по сути является фильтром и позволяет комбинирование фильтров, что даёт мощный инструмент для построения запросов.</p><p>Пример использования спецификаций:</p><p>Объявляем наши спецификации:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Specification</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>firstNameOrLastNameOrLoginLike</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span> <span class=n>search</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Specification</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Predicate</span> <span class=nf>toPredicate</span><span class=o>(</span><span class=n>Root</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>root</span><span class=o>,</span> <span class=n>CriteriaQuery</span><span class=o>&lt;?&gt;</span> <span class=n>query</span><span class=o>,</span> <span class=n>CriteriaBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>Predicate</span> <span class=n>loginPredicate</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>like</span><span class=o>(</span><span class=n>root</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>User_</span><span class=o>.</span><span class=na>login</span><span class=o>),</span> <span class=n>search</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Predicate</span> <span class=n>firstnamePredicate</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>like</span><span class=o>(</span><span class=n>root</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>User_</span><span class=o>.</span><span class=na>firstname</span><span class=o>),</span> <span class=n>search</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Predicate</span> <span class=n>lastnamePredicate</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>like</span><span class=o>(</span><span class=n>root</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>User_</span><span class=o>.</span><span class=na>lastname</span><span class=o>),</span> <span class=n>search</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>builder</span><span class=o>.</span><span class=na>or</span><span class=o>(</span><span class=n>loginPredicate</span><span class=o>,</span> <span class=n>firstnamePredicate</span><span class=o>,</span> <span class=n>lastnamePredicate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>};</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Specification</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>hasRole</span><span class=o>(</span><span class=kd>final</span> <span class=n>Role</span> <span class=n>role</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Specification</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Predicate</span> <span class=nf>toPredicate</span><span class=o>(</span><span class=n>Root</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>root</span><span class=o>,</span> <span class=n>CriteriaQuery</span><span class=o>&lt;?&gt;</span> <span class=n>query</span><span class=o>,</span> <span class=n>CriteriaBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>builder</span><span class=o>.</span><span class=na>equal</span><span class=o>(</span><span class=n>root</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>User_</span><span class=o>.</span><span class=na>role</span><span class=o>),</span> <span class=n>role</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>};</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>И в нашем сервисе комбинируем их:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Page</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=nf>searchUser</span><span class=o>(</span><span class=n>Role</span> <span class=n>role</span><span class=o>,</span> <span class=n>String</span> <span class=n>search</span><span class=o>,</span> <span class=n>Pageable</span> <span class=n>pageable</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Specifications</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>mainSpec</span> <span class=o>=</span> <span class=n>where</span><span class=o>(</span><span class=n>hasRole</span><span class=o>(</span><span class=n>role</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// уточняем запрос, если была передана строка для поиска
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>isNotBlank</span><span class=o>(</span><span class=n>search</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mainSpec</span> <span class=o>=</span> <span class=n>mainSpec</span><span class=o>.</span><span class=na>and</span><span class=o>(</span><span class=n>firstNameOrLastNameOrLoginLike</span><span class=o>(</span><span class=n>search</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>userRepository</span><span class=o>.</span><span class=na>findAll</span><span class=o>(</span><span class=n>mainSpec</span><span class=o>,</span> <span class=n>pageable</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div></div><footer><div class=social><ul><li class=sidebar-nav-item><a target=_blank href=https://github.com/uthark/ title=https://github.com/uthark/><i class="fa fa-github fa-2x"></i></a></li><li class=sidebar-nav-item><a target=_blank href=https://bitbucket.org/uthark/ title=https://bitbucket.org/uthark/><i class="fa fa-bitbucket fa-2x"></i></a><li class=sidebar-nav-item><a target=_blank href=https://twitter.com/real_atamanenko title=https://twitter.com/real_atamanenko><i class="fa fa-twitter fa-2x"></i></a><li class=sidebar-nav-item><a target=_blank href=https://keybase.io/uthark/ title=https://keybase.io/uthark/><i class="fa fa-key fa-2x"></i></a><li class=sidebar-nav-item><a target=_blank href=http://stackoverflow.com/users/216764/uthark title=http://stackoverflow.com/users/216764/uthark><i class="fa fa-stack-overflow fa-2x"></i></a></li><li><a href=https://feeds.feedburner.com/atamanenko target=_blank type=application/rss+xml title=RSS><i class="fa fa-rss-square fa-2x"></i></a></li></ul></div><p>&copy;&nbsp;2009&nbsp;—&nbsp;2022 Oleg Atamanenko - <a href=https://uthark.github.io/license/>CC&nbsp;BY-SA&nbsp;4.0</a></p></footer><script>var _gaq=[['_setAccount','UA-8688665-1'],['_trackPageview']];(function(t,n){var s=t.createElement(n),e=t.getElementsByTagName(n)[0];e.async='async',s.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js',e.parentNode.insertBefore(s,e)})(document,'script')</script></body></html></body></html>