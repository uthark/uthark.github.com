<!doctype html><html>
<head>
<meta charset=utf-8>
<title>
Вложенные транзакции в базах данных &ndash; Oleg Atamanenko
</title>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1">
<link rel=stylesheet media=screen href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300&family=Prata&display=swap" type=text/css>
<link rel=stylesheet href=https://uthark.github.io/css/theme.72254bdf9ec9fc2d8b013dd5c21997b2ab476af1a37ded5995aae71c4a63d57d.css>
<link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css>
<link href=https://uthark.github.io/favicon.png rel=icon>
</head>
<body>
<header class=site>
<h1><a href=https://uthark.github.io/>Oleg Atamanenko</a></h1>
<h2>thoughts about programming</h2>
</header>
<nav>
<ul class=main-navigation>
<li><a href=https://uthark.github.io/ title=Posts>Posts</a></li>
<li><a href=https://uthark.github.io/categories/ title=Categories>Categories</a></li>
<li><a href=https://uthark.github.io/usefularticles/ title=Links>Links</a></li>
<li><a href=https://uthark.github.io/about/ title="About me">About me</a></li>
</ul>
</nav>
<div class=article>
<h1>Вложенные транзакции в базах данных</h1>
<p>Summary: Некоторые особенности вложенных транзакций.<br>
<br>
Иногда бывает так, что при обработке запроса необходимо открыть ещё одну транзакцию в рамках текущей транзакции. Это называется вложенной транзакцией. <br>
<br>
Очень многие базы данных не поддерживают вложенные транзакции вообще, например, MySQL и Oracle. А те, что поддерживают, делают это на минимальном уровне, например, Sybase поддерживает только псевдовложенные транзакции.<br>
<br>
Вложенные транзакции могут быть следующих видов:<br>
<br></p>
<ol><li>Псевдо-вложенные транзакции</li>
<li>Вложенная субтранзакция</li>
<li>Вложенная независимая транзакция</li>
</ol><br>
<h3>Псевдовложенные транзакции</h3><br>
Этот тип транзакций поддерживается базой данных Sybase.<br>
Псевдо-вложенные транзакции позволяют использовать транзакции одна внутри другой, при этом не реализуя механизм вложенных транзакций. Суть состоит в том, что имеется счётчик уровня вложенности транзакций, который увеличивается на 1 при каждом вызове <tt>BEGIN TRANSACTION</tt> и уменьшается на 1 при каждом вызове <tt>COMMIT</tt>. Когда счётчик становится равным 0 происходит коммит всех произведённых изменений.<br>
<br>
Если во время проведения транзакции происходит ошибка, то вызывается <tt>ROLLBACK</tt>, но здесь есть загвоздка - что делать с последующими вызовами <tt>BEGIN TRANSACTION</tt> и <tt>COMMIT</tt>. Оптимальным решением является кидание исключения, но это необходимо отслеживать и учитывать на стадии проектирования и реализации, чтобы не возникло неприятных ситуаций при эксплуатации.<br>
<br>
Псевдовложенные транзакции являются самым простым способом реализации вложенных транзакций.<br>
<br>
Пример псевдотранзакции для базы данных Sybase:<br>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>begin</span><span class=w> </span><span class=n>tran</span><span class=w>
</span><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>trancount</span><span class=w>
</span><span class=w>    </span><span class=cm>/* @@trancount = 1 */</span><span class=w>
</span><span class=w>    </span><span class=k>begin</span><span class=w> </span><span class=n>tran</span><span class=w>
</span><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>trancount</span><span class=w>
</span><span class=w>        </span><span class=cm>/* @@trancount = 2 */</span><span class=w>
</span><span class=w>        </span><span class=k>begin</span><span class=w> </span><span class=n>tran</span><span class=w>
</span><span class=w>            </span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>trancount</span><span class=w>
</span><span class=w>            </span><span class=cm>/* @@trancount = 3 */</span><span class=w>
</span><span class=w>        </span><span class=k>commit</span><span class=w> </span><span class=n>tran</span><span class=w>
</span><span class=w>    </span><span class=k>commit</span><span class=w> </span><span class=n>tran</span><span class=w>
</span><span class=w></span><span class=k>commit</span><span class=w> </span><span class=n>tran</span><span class=w>
</span><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>trancount</span><span class=w>
</span><span class=w></span><span class=cm>/* @@ trancount = 0 */</span><span class=w>
</span></code></pre></div><h3>Вложенная субтранзакция</h3><br>
Данный вид вложенных транзакций решает проблему с обработкой ошибок при <tt>ROLLBACK</tt>. <br>
При коммите вложенной транзакции происходит коммит, но он не обладает свойством <tt>Durability</tt> - окончательный результат зависит от результата внешней транзакции - если внешняя транзакция заканчивается успешно, то и результат внутренней транзакции также фиксируется. Если же при фиксации изменений внешней транзакции происходит ошибка, то внутренняя транзакция также откатывается. Кроме того, необходимо обратить внимание на то, что если внутренняя транзакция заканчивается неуспешно, то внешняя транзакция может закончиться успешно, если не выкинуть исключение наружу. Таким образом, для данного вида вложенных транзакций необходимо выкидывать исключение наружу, для того, чтобы прервать и откатить внешнюю транзакцию в случае ошибки.<br>
<br>
<h3>Вложенная независимая транзакция</h3>Особенность данного вида вложенных транзакций заключается в том, что после создания вложенной транзакции она является полностью независимой от транзакции, внутри которой она была создана. Её результаты фиксируются и откатываются независимо от внешней транзакции.<br>
<br>
<h3>Вложенные транзакции и принципы ACID</h3>Вложенные транзакции выглядят достаточно подозрительными в том смысле, что они могут нарушать принципы ACID: <br>
1. Вложенная субтранзакция может нарушать принцип <tt>Durability</tt>, так как уже зафиксированные изменения могут откатиться в случае отката внешней транзакции.<br>
2. Вложенная независимая транзакция может нарушать принципы <tt>Atomicity</tt> и <tt>Consistency</tt> при возникновении ошибок во внешней или вложенной транзакции.<br>
<br>
Подробнее о принципах <abbr title="Atomicity, Consistency, Isolation, Durability">ACID</abbr> можно прочитать в <a href=//2009/04/blog-post_24.html>этом посте</a>.<br>
<br>
<h3>Заключение</h3>Я считаю, что следует избегать ситуаций, когда нужны вложенные транзакции. Кроме того, спецификация Java EE <a href=http://java.sun.com/javaee/6/docs/api/javax/ejb/TransactionAttributeType.html>не поддерживает</a> вложенные транзакции.
</div>
<footer>
<div class=social>
<ul>
<li class=sidebar-nav-item><a target=_blank href=https://github.com/uthark/ title=https://github.com/uthark/><i class="fa fa-github fa-2x"></i></a>
</li>
<li class=sidebar-nav-item> <a target=_blank href=https://bitbucket.org/uthark/ title=https://bitbucket.org/uthark/><i class="fa fa-bitbucket fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://twitter.com/real_atamanenko title=https://twitter.com/real_atamanenko><i class="fa fa-twitter fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=https://keybase.io/uthark/ title=https://keybase.io/uthark/><i class="fa fa-key fa-2x"></i></a>
<li class=sidebar-nav-item><a target=_blank href=http://stackoverflow.com/users/216764/uthark title=http://stackoverflow.com/users/216764/uthark><i class="fa fa-stack-overflow fa-2x"></i></a>
</li>
<li><a href=https://feeds.feedburner.com/atamanenko target=_blank type=application/rss+xml title=RSS><i class="fa fa-rss-square fa-2x"></i></a></li>
</ul>
</div>
<p>&copy;&nbsp;2009&nbsp;—&nbsp;2021 Oleg Atamanenko - <a href=https://uthark.github.io/license/>CC&nbsp;BY-SA&nbsp;4.0</a>
</p>
</footer>
<script>var _gaq=[['_setAccount','UA-8688665-1'],['_trackPageview']];(function(b,c){var d=b.createElement(c),a=b.getElementsByTagName(c)[0];a.async='async',d.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js',a.parentNode.insertBefore(d,a)})(document,'script')</script>
</body>
</html>
</body>
</html>